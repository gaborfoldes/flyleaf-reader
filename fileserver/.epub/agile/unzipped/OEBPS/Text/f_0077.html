<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="heading_id_2">13.1 Iteration H1: Sending Confirmation Emails</h2>

  <p id="N15F25">There are three basic parts to sending email in Rails: configuring how email is to be sent, determining when to send the email, and specifying what you want to say. We will cover each of these three in turn.</p>

  <h3 id="sec.email.config">Email Configuration</h3>

  <p id="N15F38">Email configuration is part of a Rails application’s environment and involves a <code class="cf ic">Depot::Application.configure</code> block. If you want to use the same configuration for development, testing, and production, add the configuration to <code class="cf filename">environment.rb</code> in the <code class="cf dir">config</code> directory; otherwise, add different configurations to the appropriate files in the <code class="cf dir">config/environments</code> directory.</p>

  <p id="N15F55">Inside the block, you will need to have one or more statements. You first have to decide how you want mail delivered:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">config.action_mailer.delivery_method = :smtp | :sendmail | :test</code></td>
    </tr>
  </table>

  <p id="N15F78">The <code class="cf ic">:smtp</code> and <code class="cf ic">:sendmail</code> options are used when you want Action Mailer to attempt to deliver email. You’ll clearly want to use one of these methods in production.</p>

  <p id="N15F81">The <code class="cf ic">:test</code> setting is great for unit and functional testing, which we will make use of in <a href="#sec.email.testing">​<em>Function Testing Email</em>​</a>. Email will not be delivered; instead, it will be appended to an array (accessible via the attribute <code class="cf variable">ActionMailer::Base.deliveries</code>). This is the default delivery method in the test environment. Interestingly, though, the default in development mode is <code class="cf ic">:smtp</code>. If you want Rails to deliver email during the development of your application, this is good. If you’d rather disable email delivery in development mode, edit the file <code class="cf filename">development.rb</code> in the directory <code class="cf dir">config/environments</code>, and add the following lines:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Depot::Application.configure <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">config.action_mailer.delivery_method = :test</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N15FAF">The <code class="cf ic">:sendmail</code> setting delegates mail delivery to your local system’s <code class="cf commandname">sendmail</code> program, which is assumed to be in <code class="cf dir">/usr/sbin</code>. This delivery mechanism is not particularly portable, because <code class="cf commandname">sendmail</code> is not always installed in this directory on different operating systems. It also relies on your local <code class="cf commandname">sendmail</code> supporting the <code class="cf commandoption">-i</code> and <code class="cf commandoption">-t</code> command options.</p>

  <p id="p.am.server.settings">You achieve more portability by leaving this option at its default value of <code class="cf ic">:smtp</code>. If you do so, you’ll need also to specify some additional configuration to tell Action Mailer where to find an SMTP server to handle your outgoing email. This may be the machine running your web application, or it may be a separate box (perhaps at your ISP if you’re running Rails in a noncorporate environment). Your system administrator will be able to give you the settings for these parameters. You may also be able to determine them from your own mail client’s configuration.</p>

  <p id="N15FFF">The following are typical settings for Gmail. Adapt them as you need.</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Depot::Application.configure <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">config.action_mailer.delivery_method = :smtp</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">config.action_mailer.smtp_settings = {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">address: <em class="string">"smtp.gmail.com"</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">port: 587,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">domain: <em class="string">"domain.of.sender.net"</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">authentication: <em class="string">"plain"</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">user_name: <em class="string">"dave"</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">password: <em class="string">"secret"</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">enable_starttls_auto: true</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N16047">As with all configuration changes, you’ll need to restart your application if you make changes to any of the environment files.</p>

  <h3 id="heading_id_3">Sending Email</h3>

  <p id="N1604E">Now that we have everything configured, let’s write some code to send emails.</p>

  <p id="N16058">By now you shouldn’t be surprised that Rails has a generator script to create mailers. What might be surprising is where it creates them. In Rails, a mailer is a class that’s stored in the <code class="cf dir">app/mailers</code> directory. It contains one or more methods, with each method corresponding to an email template. To create the body of the email, these methods in turn use views (in just the same way that controller actions use views to create HTML and XML). So, let’s create a mailer for our store application. We’ll use it to send two different types of email: one when an order is placed and a second when the order ships. The <code class="cf commandname">rails generate mailer</code> command takes the name of the mailer class, along with the names of the email action methods:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rails generate mailer OrderNotifier received shipped</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">create app/mailers/order_notifier.rb</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">invoke erb</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">create app/views/order_notifier</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">create app/views/order_notifier/received.text.erb</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">create app/views/order_notifier/shipped.text.erb</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">invoke test_unit</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">create test/functional/order_notifier_test.rb</code></td>
    </tr>
  </table>

  <p id="N16096">Notice that we’ve created an <code class="cf class">OrderNotifier</code> class in <code class="cf dir">app/mailers</code> and two template files, one for each email type, in <code class="cf dir">app/views/notifier</code>. (We also created a test file&mdash;we’ll look into this later in <a href="#sec.email.testing">​<em>Function Testing Email</em>​</a>.)</p>

  <p id="N160A5">Each method in the mailer class is responsible for setting up the environment for sending a particular email. Let’s look at an example before going into the details. Here’s the code that was generated for our <code class="cf class">OrderNotifier</code> class, with one default changed:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_q/app/mailers/order_notifier.rb">rails31/depot_q/app/mailers/order_notifier.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> OrderNotifier &lt; ActionMailer::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">default from: <em class="string">'Sam Ruby &lt;depot@example.com&gt;'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># Subject can be set in your I18n file at config/locales/en.yml</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># with the following lookup:</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">#</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># en.order_notifier.received.subject</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">#</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> received</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@greeting = <em class="string">"Hi"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">mail to: <em class="string">"to@example.org"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># Subject can be set in your I18n file at config/locales/en.yml</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># with the following lookup:</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">#</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># en.order_notifier.shipped.subject</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">#</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> shipped</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@greeting = <em class="string">"Hi"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">mail to: <em class="string">"to@example.org"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N16126">If you are thinking to yourself that this looks like a controller, it is because it very much does. One method per action. Instead of a call to render, there is a call to mail. Mail accepts a number of parameters including <code class="cf ic">:to</code> (as shown), <code class="cf ic">:cc</code>, <code class="cf ic">:from</code>, and <code class="cf ic">:subject</code>, each of which does pretty much what you would expect them to do. Values that are common to all mail calls in the mailer can be set as defaults by simply calling <code class="cf ic">default</code>, as is done for <code class="cf ic">:from</code> at the top of this class. Feel free to tailor this to your needs.</p>

  <p id="N1613B">The comments in this class also indicate that subject lines are already enabled for translation, a subject we cover in Chapter 15, <a href="../Text/f_0086.html#chp.i18n">​<em>Task J: Internationalization</em>​</a>. For now, we will simply use the <code class="cf ic">:subject</code> parameter.</p>

  <p id="N16144">As with controllers, templates contain the text to be sent, and controllers and mailers can provide values to be inserted into those templates via instance variables.</p>

  <h4 id="heading_id_4">Email Templates</h4>

  <p id="N1614B">The generate script created two email templates in <code class="cf dir">app/views/order_notifier</code>, one for each action in the <code class="cf class">Notifier</code> class. These are regular <code class="cf fileextension">erb</code> files. We’ll use them to create plain-text emails (we’ll see later how to create HTML email). As with the templates we use to create our application’s web pages, the files contain a combination of static text and dynamic content. We can customize the template in <code class="cf filename">received.text.erb</code>; this is the email that is sent to confirm an order:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_q/app/views/order_notifier/received.text.erb">rails31/depot_q/app/views/order_notifier/received.text.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Dear &lt;%= @order.name %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Thank you for your recent order from The Pragmatic Store.</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">You ordered the following items:</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= render @order.line_items %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">We'll send you a separate e-mail when your order ships.</code></td>
    </tr>
  </table>

  <p id="N16185">The partial template that renders a line item formats a single line with the item quantity and the title. Because we’re in a template, all the regular helper methods, such as <code class="cf methodname">truncate</code>, are available:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_q/app/views/line_items/_line_item.text.erb">rails31/depot_q/app/views/line_items/_line_item.text.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= sprintf(<em class="string">"%2d x %s"</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">line_item.quantity,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">truncate(line_item.product.title, length: 50)) %&gt;</code></td>
    </tr>
  </table>

  <p id="N161A0">We now have to go back and fill in the <code class="cf methodname">received</code> method in the <code class="cf class">OrderNotifier</code> class:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_r/app/mailers/order_notifier.rb">rails31/depot_r/app/mailers/order_notifier.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> received(order)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@order = order</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">mail to: order.email, subject: <em class="string">'Pragmatic Store Order Confirmation'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N161C6">What we did here is add <code class="cf ic">order</code> as an argument to the method-received call, add code to copy the parameter passed into an instance variable, and update the call to <code class="cf methodname">mail</code> specifying where to send the email and what subject line to use.</p>

  <h4 id="heading_id_5">Generating Emails</h4>

  <p id="N161D8">Now that we have our template set up and our mailer method defined, we can use them in our regular controllers to create and/or send emails.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_r/app/controllers/orders_controller.rb">rails31/depot_r/app/controllers/orders_controller.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> create</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@order = Order.new(params[:order])</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@order.add_line_items_from_cart(current_cart)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">respond_to <strong class="prompt">do</strong> |format|</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> @order.save</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Cart.destroy(session[:cart_id])</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">session[:cart_id] = nil</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">OrderNotifier.received(@order).deliver</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.html { redirect_to store_url, notice:</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="string">'Thank you for your order.'</em> }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.json { render json: @order, status: :created,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">location: @order }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@cart = current_cart</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.html { render action: <em class="string">"new"</em> }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.json { render json: @order.errors,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">status: :unprocessable_entity }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N16235">And we need to update the <code class="cf methodname">shipped</code> just like we did for <code class="cf methodname">received</code>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_r/app/mailers/order_notifier.rb">rails31/depot_r/app/mailers/order_notifier.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> shipped(order)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@order = order</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">mail to: order.email, subject: <em class="string">'Pragmatic Store Order Shipped'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1625B">At this point, we have enough of the basics in place that you can place an order and have a plain email sent to yourself, presuming that you didn’t disable the sending of email in development mode. Now let’s spice up the email with a bit of formatting.</p>

  <h4 id="sec.multipart">Delivering Multiple Content Types</h4>

  <p id="N1626A">Some people prefer receiving email in plain-text format, while others like the look of an HTML email. Rails makes it easy to send email messages that contain alternative content formats, allowing the user (or their email client) to decide what they’d prefer to view.</p>

  <p id="N1626D">In the preceding section, we created a plain-text email. The view file for our <code class="cf ic">received</code> action was called <code class="cf filename">received.text.erb</code>. This is the standard Rails naming convention. We can also create HTML-formatted emails.</p>

  <p id="N1627C">Let’s try this with the order shipped notification. We don’t need to modify any code; we simply need to create a new template:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_r/app/views/order_notifier/shipped.html.erb">rails31/depot_r/app/views/order_notifier/shipped.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;h3&gt;</strong>Pragmatic Order Shipped<strong class="prompt">&lt;/h3&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;p&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">This is just to let you know that we've shipped your recent order:</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/p&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;table&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;tr&gt;</strong> <strong class="prompt">&lt;th</strong> colspan=<em class="string">"2"</em> <strong class="prompt">&gt;</strong>Qty<strong class="prompt">&lt;/th&gt;</strong> <strong class="prompt">&lt;th&gt;</strong>Description<strong class="prompt">&lt;/th&gt;</strong> <strong class="prompt">&lt;/tr&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= render @order.line_items %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/table&gt;</strong></code></td>
    </tr>
  </table>

  <p id="N162BD">We don’t even need to modify the partial, because the existing one we already have will do just fine:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_r/app/views/line_items/_line_item.html.erb">rails31/depot_r/app/views/line_items/_line_item.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">if</strong> line_item == @current_item %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;tr</strong> id=<em class="string">"current_item"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">else</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;tr&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td&gt;</strong>&lt;%= line_item.quantity %&gt;&amp;times;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td&gt;</strong>&lt;%= line_item.product.title %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td</strong> class=<em class="string">"item_price"</em> <strong class="prompt">&gt;</strong>&lt;%= number_to_currency(line_item.total_price) %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/tr&gt;</strong></code></td>
    </tr>
  </table>

  <p id="N16309">But, for email templates, there’s a little bit more naming magic. If you create multiple templates with the same name but with different content types embedded in their filenames, Rails will send all of them in one email, arranging the content so that the email client will be able to distinguish each.</p>

  <p id="N1630C">This means you will want to either update or delete the plain-text template that Rails provided for the <code class="cf ic">shipped</code> notifier.</p>

  <div class="xxxsays">
    <div class="heading">
      <div class="persons-picture"><img alt="Joe asks:" src="../Images/joe.jpg" /></div>

      <div class="label">
        Joe asks:
      </div>

      <div class="title">
        Can I Also Receive Email?
      </div>
    </div>

    <div class="body">
      <p id="N16315">Action Mailer makes it easy to write Rails applications that handle incoming email. Unfortunately, you need to find a way to retrieve appropriate emails from your server environment and inject them into the application; this requires a bit more work.</p>

      <p id="N1631E">The easy part is handling an email within your application. In your Action Mailer class, write an instance method called <code class="cf methodname">receive</code> that takes a single parameter. This parameter will be a <code class="cf class">Mail::Message</code> object corresponding to the incoming email. You can extract fields, the body text, and/or attachments and use them in your application.</p>

      <p id="N16332">All the normal techniques for intercepting incoming email end up running a command, passing that command the content of the email as standard input. If we make the Rails <code class="cf ic">runner</code> script the command that’s invoked whenever an email arrives, we can arrange to pass that email into our application’s email-handling code. For example, using procmail-based interception, we could write a rule that looks something like the example that follows. Using the arcane syntax of procmail, this rule copies any incoming email whose subject line contains <span class="emph">Bug Report</span> through our <code class="cf ic">runner</code> script:</p>

      <table class="processedcode">
        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">RUBY=/opt/local/bin/ruby</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">TICKET_APP_DIR=/Users/dave/Work/depot</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">HANDLER='IncomingTicketHandler.receive(STDIN.read)'</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">:0 c</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">* ^Subject:.*Bug Report.*</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">| cd $TICKET_APP_DIR &amp;&amp; $RUBY runner $HANDLER</code></td>
        </tr>
      </table>

      <p id="N1635A">The <code class="cf methodname">receive</code> class method is available to all Action Mailer classes. It takes the email text, parses it into a <code class="cf ic">TMail</code> object, creates a new instance of the receiver’s class, and passes the <code class="cf ic">Mail</code> object to the <code class="cf methodname">receive</code> instance method in that class.</p>
    </div>
  </div>

  <h3 id="sec.email.testing">Function Testing Email</h3>

  <p id="N16379">When we used the generate script to create our order mailer, it automatically constructed a corresponding <code class="cf filename">order_notifier_test.rb</code> file in the application’s <code class="cf dir">test/functional</code> directory. It is pretty straightforward; it simply calls each action and verifies selected portions of the email produced. As we have tailored the email, let’s update the test case to match:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_r/test/functional/order_notifier_test.rb">rails31/depot_r/test/functional/order_notifier_test.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">require <em class="string">'test_helper'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> OrderNotifierTest &lt; ActionMailer::TestCase</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">test <em class="string">"received"</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">mail = OrderNotifier.received(orders(:one))</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_equal <em class="string">"Pragmatic Store Order Confirmation"</em>, mail.subject</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_equal [<em class="string">"dave@example.org"</em>], mail.to</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_equal [<em class="string">"depot@example.com"</em>], mail.from</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_match /1 x Programming Ruby 1.9/, mail.body.encoded</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">test <em class="string">"shipped"</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">mail = OrderNotifier.shipped(orders(:one))</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_equal <em class="string">"Pragmatic Store Order Shipped"</em>, mail.subject</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_equal [<em class="string">"dave@example.org"</em>], mail.to</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_equal [<em class="string">"depot@example.com"</em>], mail.from</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_match /&lt;td&gt;1&amp;times;&lt;\/td&gt;\s*&lt;td&gt;Programming Ruby 1.9&lt;\/td&gt;/,</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">mail.body.encoded</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N163F7">The test method instructs the mail class to create (but not to send) an email, and we use assertions to verify that the dynamic content is what we expect. Note the use of <code class="cf methodname">assert_match</code> to validate just part of the body content. Your results may differ depending on how you tailored the <code class="cf ic">default :from</code> line in your <code class="cf class">Notifier</code>.</p>

  <p id="N16403">At this point, we have verified that the message we intend to create is formatted correctly, but we haven’t verified that it is sent when the customer completes the ordering process. For that, we employ integration tests.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
