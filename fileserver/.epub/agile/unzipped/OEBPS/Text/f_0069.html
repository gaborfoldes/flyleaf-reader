<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="sec.hiding.cart">11.4 Iteration F4: Hiding an Empty Cart</h2>

  <p id="N14DC2">There’s one last request from the customer. Right now, even carts with nothing in them are still displayed in the sidebar. Can we arrange for the cart to appear only when it has some content? But of course!</p>

  <p id="N14DCC">In fact, we have a number of options. The simplest is probably to include the HTML for the cart only if the cart has something in it. We could do this totally within the <code class="cf filename">_cart</code> partial:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">&lt;% unless cart.line_items.empty? %&gt;</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"cart_title"</em> <strong class="prompt">&gt;</strong>Your Cart<strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;table&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">&lt;%= render(cart.line_items) %&gt;</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;tr</strong> class=<em class="string">"total_line"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td</strong> colspan=<em class="string">"2"</em> <strong class="prompt">&gt;</strong>Total<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td</strong> class=<em class="string">"total_cell"</em> <strong class="prompt">&gt;</strong> <em class="comment">&lt;%= number_to_currency(cart.total_price) %&gt;</em> <strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/tr&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/table&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">&lt;%= button_to 'Empty cart', cart, method: :delete,</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">confirm: 'Are you sure?' %&gt;</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">&lt;% end %&gt;</em></code></td>
    </tr>
  </table>

  <p id="N14E33">Although this works, the user interface is somewhat brutal: the whole sidebar redraws on the transition between a cart that’s empty and a cart with something in it. So, let’s not use this code. Instead, let’s smooth it out a little.</p>

  <p id="N14E36">The jQuery UI library also provides transitions that make elements appear. Let’s use the <code class="cf ic">blind</code> option on <code class="cf methodname">show</code> which will smoothly reveal the cart, sliding the rest of the sidebar down to make room.</p>

  <p id="N14E5D">Not surprisingly, we’ll again use our existing <code class="cf fileextension">js.erb</code> template to call the effect. Because the <code class="cf filename">create</code> template is invoked only when we add something to the cart, we know that we have to reveal the cart in the sidebar whenever there is exactly one item in the cart (because that means previously the cart was empty and hence hidden). And, because the cart should be visible before we start the highlight effect, we’ll add the code to reveal the cart before the code that triggers the highlight.</p>

  <p id="N14E66">The template now looks like this:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_n/app/views/line_items/create.js.erb">rails31/depot_n/app/views/line_items/create.js.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">if ($('#cart tr').length == 1) { $('#cart').show('blind', 1000); }</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$('#cart').html("&lt;%=j render @cart %&gt;");</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$('#current_item').css({'background-color':'#88ff88'}).</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">animate({'background-color':'#114411'}, 1000);</code></td>
    </tr>
  </table>

  <p id="N14E82">We also have to arrange to hide the cart when it’s empty. There are two basic ways of doing this. One, illustrated by the code at the start of this section, is not to generate any HTML at all. Unfortunately, if we do that, then when we add something to the cart and suddenly create the cart HTML, we see a flicker in the browser as the cart is first displayed and then hidden and slowly revealed by the <code class="cf ic">blind</code> effect.</p>

  <p id="N14E88">A better way to handle the problem is to create the cart HTML but set the CSS style to <code class="cf ic">display:&nbsp;none</code> if the cart is empty. To do that, we need to change the <code class="cf filename">application.html.erb</code> layout in <code class="cf dir">app/views/layouts</code>. Our first attempt is something like this:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;div id=<em class="string">"cart"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;<em class="string">% if</em> @cart.line_items.empty? <em class="string">%&gt;</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="string">style="display: none"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="string">&lt;% end %&gt;</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;<em class="string">%= render(@cart) %&gt;</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="string">&lt;/div&gt;</em></code></td>
    </tr>
  </table>

  <p id="N14EBD">This code adds the CSS <code class="cf ic">style=</code> attribute to the <code class="cf xmltag">&lt;div&gt;</code> tag, but only if the cart is empty. It works fine, but it’s really, really ugly. That dangling <code class="cf ic">&gt;</code> character looks misplaced (even though it isn’t), and the way logic is interjected into the middle of a tag is the kind of thing that gives templating languages a bad name. Let’s not let that kind of ugliness litter our code. Instead, let’s create an abstraction that hides it&mdash;we’ll write a helper method.</p>

  <h3 id="heading_id_2">Helper Methods</h3>

  <p id="N14ECD">Whenever we want to abstract some processing out of a view (any kind of view), we should write a helper method.</p>

  <p id="N14EDD">If you look in the <code class="cf dir">app</code> directory, you’ll find six subdirectories:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">ls -p app</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assets/ controllers/ helpers/ mailers/ models/ views/</code></td>
    </tr>
  </table>

  <p id="N14EF4">Not surprisingly, our helper methods go in the <code class="cf dir">helpers</code> directory. If you look in that directory, you’ll find it already contains some files:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">ls -p app/helpers</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">application_helper.rb line_items_helper.rb store_helper.rb</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">carts_helper.rb products_helper.rb</code></td>
    </tr>
  </table>

  <p id="N14F14">The Rails generators automatically created a helper file for each of our controllers (products and store). The Rails command itself (the one that created the application initially) created the file <code class="cf filename">application_helper.rb</code>. If you like, you can organize your methods into controller-specific helpers, but because this method will be used in the application layout, let’s put it in the application helper.</p>

  <p id="N14F1A">Let’s write a helper method called <code class="cf methodname">hidden_div_if</code>. It takes a condition, an optional set of attributes, and a block. It wraps the output generated by the block in a <code class="cf xmltag">&lt;div&gt;</code> tag, adding the <code class="cf ic">display:&nbsp;none</code> style if the condition is true. Use it in the store layout like this:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_n/app/views/layouts/application.html.erb">rails31/depot_n/app/views/layouts/application.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= hidden_div_if(@cart.line_items.empty?, id: <em class="string">'cart'</em>) <strong class="prompt">do</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= render @cart %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>
  </table>

  <p id="N14F41">We’ll write our helper so that it is visible to the store controller by adding it to <code class="cf filename">application_helper.rb</code> in the <code class="cf dir">app/helpers</code> directory:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_n/app/helpers/application_helper.rb">rails31/depot_n/app/helpers/application_helper.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">module</strong> ApplicationHelper</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> hidden_div_if(condition, attributes = {}, &amp;block)</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> condition</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">attributes[<em class="string">"style"</em>] = <em class="string">"display: none"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">content_tag(<em class="string">"div"</em>, attributes, &amp;block)</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N14F80">This code uses the Rails standard helper, <code class="cf methodname">content_tag</code>, which can be used to wrap the output created by a block in a tag. By using the <code class="cf ic">&amp;block</code> notation, we get Ruby to pass the block that was given to <code class="cf methodname">hidden_div_if</code> down to <code class="cf methodname">content_tag</code>.</p>

  <p id="N14FAC">And, finally, we need to stop setting the message in the flash that we used to display when the user empties a cart. It really isn’t needed anymore, because the cart clearly disappears from the sidebar when the catalog index page is redrawn. But there’s another reason to remove it, too. Now that we’re using Ajax to add products to the cart, the main page doesn’t get redrawn between requests as people shop. That means we’ll continue to display the flash message saying the cart is empty even as we display a cart in the sidebar.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_n/app/controllers/carts_controller.rb">rails31/depot_n/app/controllers/carts_controller.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> destroy</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@cart = current_cart</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@cart.destroy</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">session[:cart_id] = nil</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">respond_to <strong class="prompt">do</strong> |format|</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.html { redirect_to store_url }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.json { head :ok }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N14FDB">Now that we have added all this Ajax goodness, go ahead and empty your cart and add an item.</p>

  <p id="N14FDE">Although this might seem like a lot of work, there really are only two essential steps to what we did. First, we make the cart hide and reveal itself by making the CSS display style conditional on the number of items in the cart. Second, we provided JavaScript instructions to invoke the <code class="cf ic">blind</code> effect when the cart went from being empty to having one item.</p>

  <p id="N14FEB">So far, these changes have been pretty, but not functional. Let’s proceed to changing the behavior of the page itself. How about we make clicking on the image itself cause an item to be added to the cart? It turns out that that’s easy too with JQuery.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
