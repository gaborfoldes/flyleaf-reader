<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="sec.directory.structure">18.1 Where Things Go</h2>

  <p id="N18A0D">Rails assumes a certain runtime directory layout and provides application and scaffold generators, which will create this layout for you. For example, if we generate <span class="emph">my_app</span> using the command <code class="cf commandname">rails new my_app</code>, the top-level directory for our new application appears as shown in Figure 43, <a href="#fig.rails.layout">​<em>All Rails applications have this top-level directory structure.</em>​</a>. Let’s start with the text files in the top of the application directory:</p>

  <ul>
    <li>
      <p id="N18A1C"><code class="cf filename">config.ru</code> configures the Rack Webserver Interface, either to create Rails Metal applications or to use Rack Middlewares in your Rails application. These are discussed further in the Rails Guides.<a href="../Text/f_0101.html#FOOTNOTE-36" id="FNPTR-36">[36]</a></p>
    </li>

    <li>
      <p id="N18A30"><code class="cf filename">Gemfile</code> specifies the dependencies of your Rails application. You have already seen this in use when the <code class="cf ic">will_paginate</code> plugin was added to the Depot application. Application dependencies also include the database, web server, and even scripts used for deployment.</p>

      <p id="N18A3E">Technically, this file is not used by Rails itself but rather by your application. You can find calls to the Bundler<a href="../Text/f_0101.html#FOOTNOTE-37" id="FNPTR-37">[37]</a> in the <code class="cf filename">config/boot.rb</code> and <code class="cf filename">config/application.rb</code> files.</p>
    </li>

    <li>
      <p id="N18A4E"><code class="cf filename">Rakefile</code> defines tasks to run tests, create documentation, extract the current structure of your schema, and more. Type <code class="cf commandname">rake&nbsp;-</code> at a prompt for the full list. Type <code class="cf commandname">rake&nbsp;-&nbsp;<span class="emph">task</span></code> to see a more complete description of a specific task.</p>
    </li>

    <li>
      <p id="N18A63"><code class="cf filename">README</code> contains general information about the Rails framework itself.</p>
    </li>
  </ul>

  <table class="figure" id="fig.rails.layout">
    <tr>
      <td><img alt="images/rails_layout.png" src="../Images/rails_layout.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 43. All Rails applications have this top-level directory structure.</b>
      </td>
    </tr>
  </table>

  <p id="N18A83">Now let’s look at what goes into each directory (although not necessarily in order).</p>

  <h3 id="heading_id_2">A Place for Our Application</h3>

  <p id="N18A8A">Most of our work takes place in the <code class="cf dir">app</code> directory. The main code for the application lives below the <code class="cf dir">app</code> directory, as shown in Figure 44, <a href="#fig.app.dir">​<em>The main code for our application lives in the <code class="cf dir">app</code> directory.</em>​</a>. We’ll talk more about the structure of the <code class="cf dir">app</code> directory as we look at the various Rails modules such as Active Record, Action Controller, and Action View in more detail later in the book.</p>

  <table class="figure" id="fig.app.dir">
    <tr>
      <td><img alt="images/app_dir_layout.png" src="../Images/app_dir_layout.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 44. The main code for our application lives in the <code class="cf dir">app</code> directory.</b>
      </td>
    </tr>
  </table>

  <h3 id="heading_id_3">A Place for our Tests</h3>

  <p id="N18AC4">As we have seen in Section 7.2, <a href="../Text/f_0048.html#sec.unit.test">​<em>Iteration B2: Unit Testing of Models</em>​</a>, Section 8.4, <a href="../Text/f_0054.html#sec.function.test">​<em>Iteration C4: Functional Testing of Controllers</em>​</a>, and Section 13.2, <a href="../Text/f_0078.html#sec.integration.test">​<em>Iteration H2: Integration Testing of Applications</em>​</a>, Rails has ample provisions for testing your application, and the <code class="cf dir">test</code> directory is the home for all testing-related activities, including fixtures that define data used by our tests.</p>

  <h3 id="heading_id_4">A Place for Documentation</h3>

  <p id="p.rake.doc">As we saw in Section 17.2, <a href="../Text/f_0097.html#sec.documenting">​<em>Documenting What We Have Done</em>​</a>, Rails provides the <code class="cf ic">doc:app</code> Rake task to generate documentation, which it places in the <code class="cf dir">doc/</code> directory. In addition to this command, Rails provides other tasks that generate documentation: <code class="cf ic">doc:rails</code> will provide documentation for the version of Rails you are running, and <code class="cf ic">doc:guides</code> will provide usage guides. Before you build the guides, you will need to add the gem <code class="cf ic">RedCloth</code> (note: case <span class="emph">is</span> significant) to your <code class="cf filename">Gemfile</code> and run <code class="cf commandname">bundle install</code>.</p>

  <p id="N18B2B">Rails also provides other document-related tasks. To see them all, enter the command <code class="cf commandname">rake -T doc</code>.</p>

  <h3 id="heading_id_5">A Place for Supporting Libraries</h3>

  <p id="N18B35">The <code class="cf dir">lib</code> directory holds application code that doesn’t fit neatly into a model, view, or controller. For example, you may have written a library that creates PDF receipts that your store’s customers can download.<a href="../Text/f_0101.html#FOOTNOTE-38" id="FNPTR-38">[38]</a> These receipts are sent directly from the controller to the browser (using the <code class="cf methodname">send_data</code> method). The code that creates these PDF receipts will sit naturally in the <code class="cf dir">lib</code> directory.</p>

  <p id="N18B57">The <code class="cf dir">lib</code> directory is also a good place to put code that’s shared among models, views, or controllers. Maybe you need a library that validates a credit card number’s checksum, that performs some financial calculation, or that works out the date of Easter. Anything that isn’t directly a model, view, or controller should be slotted into <code class="cf dir">lib</code>.</p>

  <p id="N18B60">Don’t feel that you have to stick a bunch of files directly into the <code class="cf dir">lib</code> directory. Feel free to create subdirectories in which you group related functionality under <code class="cf dir">lib</code>. For example, on the Pragmatic Programmer site, the code that generates receipts, customs documentation for shipping, and other PDF-formatted documentation is in the directory <code class="cf dir">lib/pdf_stuff</code>.</p>

  <p id="N18B6C">In previous versions of Rails, the files in the <code class="cf dir">lib</code> directory were automatically included in the load path used to resolve <code class="cf ic">require</code> statements. This is now an option that you need to explicitly enable. To do so, place the following in <code class="cf filename">config/application.rb</code>:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">config.autoload_paths += <em class="string">%W(</em>#{Rails.root}<em class="string">/lib)</em></code></td>
    </tr>
  </table>

  <p id="N18B8B">Once you have files in the <code class="cf dir">lib</code> directory and the <code class="cf dir">lib</code> added to your autoload paths, you can use them in the rest of your application. If the files contain classes or modules and the files are named using the lowercase form of the class or module name, then Rails will load the file automatically. For example, we might have a PDF receipt writer in the file <code class="cf filename">receipt.rb</code> in the directory <code class="cf dir">lib/pdf_stuff</code>. As long as our class is named <code class="cf ic">PdfStuff::Receipt</code>, Rails will be able to find and load it automatically.</p>

  <p id="N18B9D">For those times where a library cannot meet these automatic loading conditions, you can use Ruby’s <code class="cf ic">require</code> mechanism. If the file is in the <code class="cf dir">lib</code> directory, you can require it directly by name. For example, if our Easter calculation library is in the file <code class="cf filename">lib/easter.rb</code>, we can include it in any model, view, or controller using this:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">require <em class="string">"easter"</em></code></td>
    </tr>
  </table>

  <p id="N18BC6">If the library is in a subdirectory of <code class="cf dir">lib</code>, remember to include that directory’s name in the <code class="cf ic">require</code> statement. For example, to include a shipping calculation for airmail, we might add the following line:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">require <em class="string">"shipping/airmail"</em></code></td>
    </tr>
  </table>

  <h4 id="sec.rake.tasks">A Place for Our Rake Tasks</h4>

  <p id="N18BE1">You’ll also find an empty <code class="cf dir">tasks</code> directory under <code class="cf dir">lib</code>. This is where you can write your own Rake tasks, allowing you to add automation to your project. This isn’t a book about Rake, so we won’t go into it deeply here, but here’s a simple example. Rails provides a Rake task to tell you the latest migration that has been performed.</p>

  <p id="N18BF6">But it may be helpful to see a list of <span class="emph">all</span> the migrations that have been performed. We’ll write a Rake task that prints out the versions listed in the <code class="cf ic">schema_migration</code> table. These tasks are Ruby code, but they need to be placed into files with the extension <code class="cf fileextension">rake</code>. We’ll call ours <code class="cf filename">db_schema_migrations.rake</code>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_t/lib/tasks/db_schema_migrations.rake">rails31/depot_t/lib/tasks/db_schema_migrations.rake</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">namespace :db <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">desc <em class="string">"Prints the migrated versions"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">task :schema_migrations =&gt; :environment <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">puts ActiveRecord::Base.connection.select_values(</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="string">'select version from schema_migrations order by version'</em> )</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N18C2F">We can run this from the command line just like any other Rake task:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rake db:schema_migrations</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">(in /Users/rubys/Work/...)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">20110711000001</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">20110711000002</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">20110711000003</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">20110711000004</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">20110711000005</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">20110711000006</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">20110711000007</code></td>
    </tr>
  </table>

  <p id="N18C62">Consult the Rake documentation at <a href="http://rubyrake.org/">http://rubyrake.org/</a> for more information on writing Rake tasks.</p>

  <h3 id="heading_id_6">A Place for Our Logs</h3>

  <p id="N18C72">As Rails runs, it produces a bunch of useful logging information. This is stored (by default) in the <code class="cf dir">log</code> directory. Here you’ll find three main log files, called <code class="cf filename">development.log</code>, <code class="cf filename">test.log</code>, and <code class="cf filename">production.log</code>. The logs contain more than just simple trace lines; they also contain timing statistics, cache information, and expansions of the database statements executed.</p>

  <p id="N18C8E">Which file is used depends on the environment in which your application is running (and we’ll have more to say about environments when we talk about the <code class="cf dir">config</code> directory in <a href="#sec.config">​<em>A Place for Configuration</em>​</a>).</p>

  <h3 id="heading_id_7">A Place for Static Web Pages</h3>

  <p id="N18C9B">The<code class="cf dir">public</code> directory is the external face of your application. The web server takes this directory as the base of the application. In here you place <span class="emph">static</span> (in other words, unchanging) files, such as stylesheets, JavaScript, and perhaps even some web pages.</p>

  <h3 id="heading_id_8">A Place for Scripts</h3>

  <p id="N18CAE">If you find it helpful to write scripts that are run from the command line and perform various maintenance tasks for your application, the <code class="cf dir">script</code> directory is the place to put them.</p>

  <p id="N18CBB">This directory also holds the Rails script. This is the script that is run when you run the <code class="cf ic">rails</code> command from the command line. The first argument you pass to that script determines the function Rails will perform:</p>

  <dl>
    <dt class="force-newline"><code class="cf filename">benchmarker</code></dt>

    <dd>
      <p id="N18CC8">Generates performance numbers on one or more methods in your application.</p>
    </dd>

    <dt class="force-newline"><code class="cf filename">console</code></dt>

    <dd>
      <p id="N18CE9">Allows you to interact with your Rails application methods.</p>
    </dd>

    <dt class="force-newline"><code class="cf filename">dbconsole</code></dt>

    <dd>
      <p id="N18D00">Allows you to directly interact with your database via the command line.</p>
    </dd>

    <dt class="force-newline"><code class="cf filename">destroy</code></dt>

    <dd>
      <p id="N18D14">Removes autogenerated files created by <code class="cf commandname">generate</code>.</p>
    </dd>

    <dt class="force-newline"><code class="cf filename">generate</code></dt>

    <dd>
      <p id="N18D2A">A code generator. Out of the box, it will create controllers, mailers, models, scaffolds, and web services. You can also download additional generator modules from the Rails website.<a href="../Text/f_0101.html#FOOTNOTE-39" id="FNPTR-39">[39]</a> Run <code class="cf commandname">generate</code> with no arguments for usage information on a particular generator, for example: <code class="cf commandname">rails</code> <code class="cf commandname">generate&nbsp;migration</code>.</p>
    </dd>

    <dt class="force-newline"><code class="cf filename">new</code></dt>

    <dd>
      <p id="N18D4C">Generates Rails application code.</p>
    </dd>

    <dt class="force-newline"><code class="cf filename">plugin</code></dt>

    <dd>
      <p id="N18D55">Helps you install and administer plugins&mdash;pieces of functionality that extend the capabilities of Rails.</p>
    </dd>

    <dt class="force-newline"><code class="cf filename">profiler</code></dt>

    <dd>
      <p id="N18D6E">Creates a runtime-profile summary of a URI request processed by your application.</p>
    </dd>

    <dt class="force-newline"><code class="cf filename">runner</code></dt>

    <dd>
      <p id="N18D8C">Executes a method in your application outside the context of the Web. This is the noninteractive equivalent of <code class="cf ic">rails console</code>. You could use this to invoke cache expiry methods from a <code class="cf commandname">cron</code> job or handle incoming email.</p>
    </dd>

    <dt class="force-newline"><code class="cf filename">server</code></dt>

    <dd>
      <p id="N18DA6">Runs your Rails application in a self-contained web server, using Mongrel (if it is available on your box) or WEBrick. We’ve been using this in our Depot application during development.</p>
    </dd>
  </dl>

  <h3 id="heading_id_9">A Place for Temporary Files</h3>

  <p id="N18DBD">It probably isn’t a surprise that Rails keeps its temporary files tucked in the <code class="cf dir">tmp</code> directory. You’ll find subdirectories for cache contents, sessions, and sockets in here. Generally these files are cleaned up automatically by Rails, but occasionally if things go wrong, you might need to look in here and delete old files.</p>

  <h3 id="heading_id_10">A Place for Third-Party Code</h3>

  <p id="N18DCE">The <code class="cf dir">vendor</code> directory is where third-party code lives. Nowadays, this code will typically come from two sources.</p>

  <p id="N18DDA">First, Rails installs plugins into the directories below <code class="cf dir">vendor/plugins</code>. Plugins are ways of extending Rails functionality, both during development and at runtime.</p>

  <p id="N18DE6">Second, you can install Rails and all of its dependencies into the <code class="cf dir">vendor</code> directory, as we saw in <a href="../Text/f_0093.html#sec.bundle.pack">​<em>Getting an Application Under Control</em>​</a></p>

  <p id="N18DEE">If you want to go back to using the system-wide version of gems, you can delete the <code class="cf dir">vendor/cache</code> directory.</p>

  <h3 id="sec.config">A Place for Configuration</h3>

  <p id="N18DFA">The <code class="cf dir">config</code> directory contains files that configure Rails. In the process of developing Depot, we configured a few routes, configured the database, created an initializer, modified some locales, and defined deployment instructions. The rest of the configuration was done via Rails conventions.</p>

  <p id="N18E06">Before running your application, Rails loads and executes <code class="cf filename">config/environment.rb</code> and <code class="cf filename">config/application.rb</code>. The standard environment that these files set up automatically includes the following directories (relative to your application’s base directory) in your application’s load path:</p>

  <ul>
    <li>
      <p id="N18E12">The <code class="cf dir">app/controllers</code> directory and its subdirectories</p>
    </li>

    <li>
      <p id="N18E19">The <code class="cf dir">app/models</code> directory</p>
    </li>

    <li>
      <p id="N18E20">The <code class="cf dir">vendor</code> directory and the <code class="cf dir">lib</code> contained in each <code class="cf dir">plugin</code> subdirectory</p>
    </li>

    <li>
      <p id="N18E2D">The directories <code class="cf dir">app</code>, <code class="cf dir">app/helpers</code>, <code class="cf dir">app/mailers</code>, <code class="cf dir">app/services</code>, and <code class="cf dir">lib</code></p>
    </li>
  </ul>

  <p id="N18E3E">Each of these directories is added to the load path only if it exists.</p>

  <p id="N18E41">In addition, Rails will load a per environment configuration file. This file lives in the <code class="cf dir">environments</code> directory and is where you place configuration options that vary depending on the environment.</p>

  <p id="N18E47">This is done because Rails recognizes that your needs, as a developer, are very different when writing code, testing code, and running that code in production. When writing code, you want lots of logging, convenient reloading of changed source files, in-your-face notification of errors, and so on. In testing, you want a system that exists in isolation so you can have repeatable results. In production, your system should be tuned for performance, and users should be kept away from errors.</p>

  <p id="N18E52">The switch that dictates the runtime environment is external to your application. This means that no application code needs to be changed as you move from development through testing to production. In Chapter 16, <a href="../Text/f_0091.html#chp.deployment">​<em>Task K: Deployment and Production</em>​</a>, you specified the environment on the <code class="cf ic">rake</code> command using a <code class="cf ic">RAILS_ENV</code> parameter and to Phusion Passenger using a <code class="cf ic">RailsEnv</code> line in your Apache configuration file. When starting WEBrick with the <code class="cf filename">rails server</code> command, you use the <code class="cf commandoption">-e</code> option:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rails server -e development</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rails server -e test</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rails server -e production</strong></code></td>
    </tr>
  </table>

  <p id="N18E9F">If you have special requirements, for example, if you favor having a <span class="emph">staging</span> environment, you can create your own environments. You’ll need to add a new section to the database configuration file and a new file to the <code class="cf dir">config/environments</code> directory.</p>

  <p id="N18EAE">What you put into these configuration files is entirely up to you. You can find a list of configuration parameters you can set in the Configuring Rails Applications guide you generated with the <code class="cf ic">rake doc:guides</code> command <a href="#p.rake.doc">​here​</a>. This information is also available online.<a href="../Text/f_0101.html#FOOTNOTE-40" id="FNPTR-40">[40]</a></p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
