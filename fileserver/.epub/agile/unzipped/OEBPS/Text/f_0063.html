<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="sec.handling.errors">10.2 Iteration E2: Handling Errors</h2>

  <p id="N13F46">Looking at the page displayed in <a href="#fig.depot.g.exception"></a>, it’s apparent that our application raised an exception at line 16 of the carts controller.<a href="../Text/f_0064.html#FOOTNOTE-26" id="FNPTR-26">[26]</a> That turns out to be this line:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@cart = Cart.find(params[:id])</code></td>
    </tr>
  </table>

  <p id="N13F76">If the cart cannot be found, Active Record raises a <code class="cf class">RecordNotFound</code> exception, which we clearly need to handle. The question arises&mdash;how?</p>

  <table class="figure" id="fig.depot.g.exception">
    <tr>
      <td><img alt="images/depot_g_exception.png" src="../Images/depot_g_exception.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 16. Our application spills its guts.</b>
      </td>
    </tr>
  </table>

  <p id="N13F90">We could just silently ignore it. From a security standpoint, this is probably the best move, because it gives no information to a potential attacker. However, it also means that should we ever have a bug in our code that generates bad cart ids, our application will appear to the outside world to be unresponsive&mdash;no one will know there has been an error.</p>

  <p id="N13F93">Instead, we’ll take two actions when an exception is raised. First, we’ll log the fact to an internal log file using Rails’ logger facility.<a href="../Text/f_0064.html#FOOTNOTE-27" id="FNPTR-27">[27]</a> Second, we’ll redisplay the catalog page, along with a short message to the user (something along the lines of “Invalid cart”) so they can continue to use our site.</p>

  <p id="N13F9C">Rails has a convenient way of dealing with errors and error reporting. It defines a structure called a <span class="emph">flash</span>. A flash is a bucket (actually closer to a <code class="cf class">Hash</code>) in which you can store stuff as you process a request. The contents of the flash are available to the next request in this session before being deleted automatically. Typically the flash is used to collect error messages. For example, when our <code class="cf methodname">show</code> method detects that it was passed an invalid cart id, it can store that error message in the flash area and redirect to the <code class="cf methodname">index</code> action to redisplay the catalog. The view for the index action can extract the error and display it at the top of the catalog page. The flash information is accessible within the views by using the <code class="cf variable">flash</code> accessor method.</p>

  <p id="N13FBF">Why couldn’t we just store the error in any old instance variable? Remember that after a redirect is sent by our application to the browser, the browser sends a new request back to our application. By the time we receive that request, our application has moved on&mdash;all the instance variables from previous requests are long gone. The flash data is stored in the session in order to make it available between requests.</p>

  <p id="N13FC2">Armed with all this background about flash data, we can now change our <code class="cf methodname">show</code> method to intercept bad cart ids and report on the problem:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_h/app/controllers/carts_controller.rb">rails31/depot_h/app/controllers/carts_controller.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># GET /carts/1</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># GET /carts/1.json</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> show</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">begin</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@cart = Cart.find(params[:id])</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">rescue</strong> ActiveRecord::RecordNotFound</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">logger.error <em class="string">"Attempt to access invalid cart</em> #{params[:id]}<em class="string">"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">redirect_to store_url, notice: <em class="string">'Invalid cart'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">respond_to <strong class="prompt">do</strong> |format|</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.html <em class="comment"># show.html.erb</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.json { render json: @cart }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1401A">The <code class="cf ic">rescue</code> clause intercepts the exception raised by <code class="cf methodname">Cart.find</code>. In the handler, we do the following:</p>

  <ul>
    <li>
      <p id="N1403C">Use the Rails logger to record the error. Every controller has a <code class="cf ic">logger</code> attribute. Here we use it to record a message at the <code class="cf ic">error</code> logging level.</p>
    </li>

    <li>
      <p id="N14051">Redirect to the catalog display using the <code class="cf methodname">redirect_to</code> method. The <code class="cf ic">:notice</code> parameter specifies a message to be stored in the flash as a notice. Why redirect, rather than just display the catalog, here? If we redirect, the user’s browser will end up displaying the store URL, rather than <code class="cf filename">http://.../cart/wibble</code>. We expose less of the application this way. We also prevent the user from retriggering the error by hitting the Reload button.</p>
    </li>
  </ul>

  <p id="N1407B">With this code in place, we can rerun our customer’s problematic query. This time, when we enter the following URL:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">http://localhost:3000/carts/wibble</code></td>
    </tr>
  </table>

  <p id="N14088">we don’t see a bunch of errors in the browser. Instead, the catalog page is displayed. If we look at the end of the log file (<code class="cf filename">development.log</code> in the <code class="cf dir">log</code> directory), we’ll see our message:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Started GET "/carts/wibble" for 127.0.0.1 at 2011-05-27 12:16:28 -0400</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Processing by CartsController#show as HTML</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Parameters: {"id"=&gt;"wibble"}</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">^[[1m^[[35mCart Load (0.1ms)^[[0m SELECT "carts".* FROM "carts" WHERE</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">"carts"."id" = ? LIMIT 1 [["id", "wibble"]]</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">Attempt to access invalid cart wibble</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Redirected to http://localhost:3000/</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Completed 302 Found in 3ms</code></td>
    </tr>
  </table>

  <p id="N140B1">For a much more user-friendly result, see Figure 17, <a href="#fig.depot.h.invalid_product">​<em>Much more user-oriented error message</em>​</a>.</p>

  <table class="figure" id="fig.depot.h.invalid_product">
    <tr>
      <td><img alt="images/depot_h_invalid_product.png" src="../Images/depot_h_invalid_product.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 17. Much more user-oriented error message</b>
      </td>
    </tr>
  </table>

  <p id="N140D3">On Unix machines, we’d probably use a command such as <code class="cf commandname">tail</code> or <code class="cf commandname">less</code> to view this file. On Windows, you could use your favorite editor. It’s often a good idea to keep a window open showing new lines as they are added to this file. In Unix you’d use <code class="cf commandname">tail&nbsp;-f</code>. You can download a <code class="cf commandname">tail</code> command for Windows from <a href="http://gnuwin32.sourceforge.net/packages/coreutils.htm">http://gnuwin32.sourceforge.net/packages/coreutils.htm</a> or get a GUI-based tool from <a href="http://tailforwin32.sourceforge.net/">http://tailforwin32.sourceforge.net/</a>. Finally, some OS&nbsp;X users use <code class="cf filename">Console.app</code> to track log files. Just say <code class="cf commandname">open</code>&nbsp;<span class="emph">name.log</span> at the command line.</p>

  <p id="N14110">Sensing the end of an iteration, we call our customer over and show her that the error is now properly handled. She’s delighted and continues to play with the application. She notices a minor problem on our new cart display&mdash;there’s no way to empty items out of a cart. This minor change will be our next iteration. We should make it before heading home.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
