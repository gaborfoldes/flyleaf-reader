<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="heading_id_2">12.1 Iteration G1: Capturing an Order</h2>

  <p id="N152F3">An order is a set of line items, along with details of the purchase transaction. Our cart already contains <code class="cf ic">line_items</code>, so all we need to do is add an <code class="cf ic">order_id</code> column to the <code class="cf ic">line_items</code> table and create an <code class="cf ic">orders</code> table based on the diagram <a href="../Text/f_0041.html#fig.initial.data">​here​</a>, combined with a brief chat with our customer.</p>

  <p id="N15312">First we create the order model and update the <code class="cf ic">line_items</code> table:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rails generate scaffold order name:string address:text \</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">email:string pay_type:string</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">...</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rails generate migration add_order_id_to_line_item \</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">order_id:integer</strong></code></td>
    </tr>
  </table>

  <p id="N15342">Now that we’ve created the migrations, we can apply them:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rake db:migrate</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">== CreateOrders: migrating =======================================</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">-- create_table(:orders)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">-&gt; <strong class="prompt">0.0014s</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">== CreateOrders: migrated (0.0015s) ==============================</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">== AddOrderIdToLineItem: migrating ===============================</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">-- add_column(:line_items, :order_id, :integer)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">-&gt; <strong class="prompt">0.0008s</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">== AddOrderIdToLineItem: migrated (0.0009s) ======================</code></td>
    </tr>
  </table>

  <p id="N15374">Because the database did not have entries for these two new migrations in the <code class="cf sqltable">schema_migrations</code> table, the <code class="cf ic">db:migrate</code> task applied both migrations to the database. We could, of course, have applied them separately by running the migration task after creating the individual migrations.</p>

  <div class="xxxsays" id="ask.credit.card">
    <div class="heading">
      <div class="persons-picture"><img alt="Joe asks:" src="../Images/joe.jpg" /></div>

      <div class="label">
        Joe asks:
      </div>

      <div class="title">
        Where’s the Credit-Card Processing?
      </div>
    </div>

    <div class="body">
      <p id="N15381">In the real world, we’d probably want our application to handle the commercial side of checkout. We might even want to integrate credit-card processing. However, integrating with back-end payment-processing systems requires a fair amount of paperwork and jumping through hoops. And this would distract from looking at Rails, so we’re going to punt on this particular detail for the moment.</p>

      <p id="N15384">We will come back to this in Section 26.1, <a href="../Text/f_0143.html#sec.active.merchant">​<em>Credit Card Processing with Active Merchant</em>​</a>, where we will explore a plugin that can help us with this function.</p>
    </div>
  </div>

  <h3 id="heading_id_3">Creating the Order Capture Form</h3>

  <p id="N1538E">Now that we have our tables and our models as we need them, we can start the checkout process. First, we need to add a <code class="cf keystroke">Checkout</code> button to the shopping cart. Because it will create a new order, we’ll link it back to a <code class="cf ic">new</code> action in our order controller:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/views/carts/_cart.html.erb">rails31/depot_o/app/views/carts/_cart.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"cart_title"</em> <strong class="prompt">&gt;</strong>Your Cart<strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;table&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= render(cart.line_items) %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;tr</strong> class=<em class="string">"total_line"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td</strong> colspan=<em class="string">"2"</em> <strong class="prompt">&gt;</strong>Total<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td</strong> class=<em class="string">"total_cell"</em> <strong class="prompt">&gt;</strong>&lt;%= number_to_currency(cart.total_price) %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/tr&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/table&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= button_to <em class="string">"Checkout"</em>, new_order_path, method: :get %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= button_to <em class="string">'Empty cart'</em>, cart, method: :delete,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">confirm: <em class="string">'Are you sure?'</em> %&gt;</code></td>
    </tr>
  </table>

  <p id="N153F6">The first thing we want to do is check to make sure that there’s something in the cart. If there is nothing in the cart, we redirect the user back to the storefront, provide a notice of what we did, and return immediately. This prevents people from navigating directly to the checkout option and creating empty orders. The return statement is important here; without it you will get a <span class="emph">double render error</span> because your controller will attempt to both redirect and render output.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/controllers/orders_controller.rb">rails31/depot_o/app/controllers/orders_controller.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> new</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">@cart = current_cart</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> @cart.line_items.empty?</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">redirect_to store_url, notice: <em class="string">"Your cart is empty"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">return</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@order = Order.new</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">respond_to <strong class="prompt">do</strong> |format|</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.html <em class="comment"># new.html.erb</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.json { render json: @order }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N15441">And we add a test for <span class="emph">requires item in cart</span> and modify the existing test for <span class="emph">should get new</span> to ensure that there is an item in the cart:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/test/functional/orders_controller_test.rb">rails31/depot_o/test/functional/orders_controller_test.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">test <em class="string">"requires item in cart"</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">get :new</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_redirected_to store_path</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_equal flash[:notice], <em class="string">'Your cart is empty'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">test <em class="string">"should get new"</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">cart = Cart.create</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">session[:cart_id] = cart.id</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">LineItem.create(cart: cart, product: products(:ruby))</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">get :new</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_response :success</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1548A">Now we want the <code class="cf ic">new</code> action to present our user with a form, prompting them to enter the information in the <code class="cf sqltable">orders</code> table: their name, address, email address, and payment type. This means we will need to display a Rails template containing a form. The input fields on this form will have to link to the corresponding attributes in a Rails model object, so we’ll need to create an empty model object in the <code class="cf ic">new</code> action to give these fields something to work with.</p>

  <p id="N15496">As always with HTML forms, the trick is populating any initial values into the form fields and then extracting those values back out into our application when the user hits the submit button.</p>

  <p id="N154A0">In the controller, the <code class="cf variable">@order</code> instance variable is set to reference a new <code class="cf class">Order</code> model object. This is done because the view populates the form from the data in this object. As it stands, that’s not particularly interesting. Because it’s a new model object, all the fields will be empty. However, consider the general case. Maybe we want to edit an existing order. Or maybe the user has tried to enter an order but their data has failed validation. In these cases, we want any existing data in the model shown to the user when the form is displayed. Passing in the empty model object at this stage makes all these cases consistent&mdash;the view can always assume it has a model object available.</p>

  <p id="N154AF">Then, when the user hits the submit button, we’d like the new data from the form to be extracted into a model object back in the controller.</p>

  <p id="N154B2">Fortunately, Rails makes this relatively painless. It provides us with a bunch of <span class="emph">form helper</span> methods. These helpers interact with the controller and with the models to implement an integrated solution for form handling. Before we start on our final form, let’s look at a simple example:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix"><span class="codeprefix">Line 1</span>&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">&lt;%= form_for @order do |f| %&gt;</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codeprefix">2</span>&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;p&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codeprefix">3</span>&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">&lt;%= f.label :name, "Name:" %&gt;</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codeprefix">4</span>&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">&lt;%= f.text_field :name, size: 40 %&gt;</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codeprefix">5</span>&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/p&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codeprefix">6</span>&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">&lt;% end %&gt;</em></code></td>
    </tr>
  </table>

  <table class="figure" id="fig.form.for">
    <tr>
      <td><img alt="images/form_for.png" src="../Images/form_for.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 22. Names in <code class="cf ic">form_for</code> map to objects and attributes</b>
      </td>
    </tr>
  </table>

  <p id="N15504">There are two interesting things in this code. First, the <code class="cf methodname">form_for</code> helper on line 1 sets up a standard HTML form. But it does more. The first parameter, <code class="cf ic">@order</code>, tells the method the instance variable to use when naming fields and when arranging for the field values to be passed back to the controller.</p>

  <p id="N15518">You’ll see that <code class="cf ic">form_for</code> sets up a Ruby block environment (this block ends on line 6). Within this block, you can put normal template stuff (such as the <code class="cf xmltag">&lt;p&gt;</code> tag). But you can also use the block’s parameter (<code class="cf ic">f</code> in this case) to reference a form context. We use this context on line 4 to add a text field to the form. Because the text field is constructed in the context of the <code class="cf ic">form_for</code>, it is automatically associated with the data in the <code class="cf variable">@order</code> object.</p>

  <p id="N1553B">All these relationships can be confusing. It’s important to remember that Rails needs to know both the <span class="emph">names</span> and the <span class="emph">values</span> to use for the fields associated with a model. The combination of <code class="cf ic">form_for</code> and the various field-level helpers (such as <code class="cf ic">text_field</code>) gives it this information. We can see this process in Figure 22, <a href="#fig.form.for">​<em>Names in <code class="cf ic">form_for</code> map to objects and attributes</em>​</a>.</p>

  <p id="N1554D">Now we can update the template for the form that captures a customer’s details for checkout. It’s invoked from the <code class="cf ic">new</code> action in the order controller, so the template is called <code class="cf filename">new.html.erb</code> and can be found in the directory <code class="cf dir">app/views/</code> <code class="cf dir">orders</code>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/views/orders/new.html.erb">rails31/depot_o/app/views/orders/new.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"depot_form"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;fieldset&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;legend&gt;</strong>Please Enter Your Details<strong class="prompt">&lt;/legend&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= render <em class="string">'form'</em> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/fieldset&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>
  </table>

  <p id="N15589">This template makes use of a partial named <code class="cf ic">_form</code>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/views/orders/_form.html.erb">rails31/depot_o/app/views/orders/_form.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= form_for(@order) <strong class="prompt">do</strong> |f| %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">if</strong> @order.errors.any? %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> id=<em class="string">"error_explanation"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;h2&gt;</strong>&lt;%= pluralize(@order.errors.count, <em class="string">"error"</em>) %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">prohibited this order from being saved:<strong class="prompt">&lt;/h2&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;ul&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% @order.errors.full_messages.each <strong class="prompt">do</strong> |msg| %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;li&gt;</strong>&lt;%= msg %&gt;<strong class="prompt">&lt;/li&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/ul&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"field"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= f.label :name %&gt;<strong class="prompt">&lt;br</strong> <strong class="prompt">/&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= f.text_field :name, size: 40 %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"field"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= f.label :address %&gt;<strong class="prompt">&lt;br</strong> <strong class="prompt">/&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= f.text_area :address, rows: 3, cols: 40 %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"field"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= f.label :email %&gt;<strong class="prompt">&lt;br</strong> <strong class="prompt">/&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= f.email_field :email, size: 40 %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"field"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= f.label :pay_type %&gt;<strong class="prompt">&lt;br</strong> <strong class="prompt">/&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= f.select :pay_type, Order::PAYMENT_TYPES,</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">prompt: <em class="string">'Select a payment method'</em> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"actions"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= f.submit <em class="string">'Place Order'</em> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>
  </table>

  <p id="N15672">Rails has form helpers for all the different HTML-level form elements. In the previous code, we use <code class="cf ic">text_field</code>, <code class="cf ic">email_field</code>, and <code class="cf ic">text_area</code> helpers to capture the customer’s name, email, and address. We cover form helpers in more depth in Section 21.2, <a href="../Text/f_0114.html#sec.form.helpers">​<em>Generating Forms</em>​</a>.</p>

  <p id="N1568C">The only tricky thing in there is the code associated with the selection list. We’ve assumed that the list of available payment options is an attribute of the <code class="cf class">Order</code> model. We’d better define the option array in the model <code class="cf filename">order.rb</code> before we forget:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/models/order.rb">rails31/depot_o/app/models/order.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> Order &lt; ActiveRecord::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">PAYMENT_TYPES = [ <em class="string">"Check"</em>, <em class="string">"Credit card"</em>, <em class="string">"Purchase order"</em> ]</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N156B3">In the template, we pass this array of payment type options to the <code class="cf ic">select</code> helper. We also pass the <code class="cf ic">:prompt</code> parameter, which adds a dummy selection containing the prompt text.</p>

  <p id="N156C3">Add a little CSS magic:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/assets/stylesheets/application.css.scss">rails31/depot_o/app/assets/stylesheets/application.css.scss</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">.depot_form {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">fieldset {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">background: #efe;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">legend {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">color: #dfd;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">background: #141;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">font-family: sans-serif;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">padding: 0.2em 1em;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">form {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">label {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">width: 5em;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">float: left;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">text-align: right;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">padding-top: 0.2em;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">margin-right: 0.1em;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">display: block;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">select, textarea, input {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">margin-left: 0.5em;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">.submit {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">margin-left: 4em;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">br {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">display: none</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>
  </table>

  <p id="N15733">We’re ready to play with our form. Add some stuff to your cart, and then click the <code class="cf keystroke">Checkout</code> button. You should see something like Figure 23, <a href="#fig.depot.p.checkout.1">​<em>Our checkout screen</em>​</a>.</p>

  <table class="figure" id="fig.depot.p.checkout.1">
    <tr>
      <td><img alt="images/depot_p_checkout_1.png" src="../Images/depot_p_checkout_1.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 23. Our checkout screen</b>
      </td>
    </tr>
  </table>

  <p id="N15745">Looking good! Before we move on, let’s finish the <code class="cf ic">new</code> action by adding some validation. We’ll change the <code class="cf class">Order</code> model to verify that the customer enters data for all the input fields.</p>

  <p id="N1574E">We also validate that the payment type is one of the accepted values.</p>

  <p id="N15762">Some folks might be wondering why we bother to validate the payment type, given that its value comes from a drop-down list that contains only valid values. We do it because an application can’t assume that it’s being fed values from the forms it creates. Nothing is stopping a malicious user from submitting form data directly to the application, bypassing our form. If the user set an unknown payment type, they might conceivably get our products for free.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/models/order.rb">rails31/depot_o/app/models/order.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> Order &lt; ActiveRecord::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># ...</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">validates :name, :address, :email, presence: true</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">validates :pay_type, inclusion: PAYMENT_TYPES</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N15788">Note that we already loop over the <code class="cf ic">@order.errors</code> at the top of the page. This will report validation failures.</p>

  <p id="N15795">Since we modified validation rules, we need to modify our test fixture to match:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/test/fixtures/orders.yml">rails31/depot_o/test/fixtures/orders.yml</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># Read about fixtures at http://api.rubyonrails.org/classes/Fixtures.html</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">one:</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">name: <em class="string">Dave Thomas</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">address: <em class="string">MyText</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">email: <em class="string">dave@example.org</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">pay_type: <em class="string">Check</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">two:</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">name: <em class="string">MyString</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">address: <em class="string">MyText</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">email: <em class="string">MyString</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">pay_type: <em class="string">MyString</em></code></td>
    </tr>
  </table>

  <p id="N157D7">Furthermore, for an order to be created, a line item needs to be in the cart, so we need to modify the line items test fixture too:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/test/fixtures/line_items.yml">rails31/depot_o/test/fixtures/line_items.yml</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># Read about fixtures at http://api.rubyonrails.org/classes/Fixtures.html</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">one:</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">product: <em class="string">ruby</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">order: <em class="string">one</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">two:</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">product: <em class="string">ruby</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">cart: <em class="string">one</em></code></td>
    </tr>
  </table>

  <p id="N15803">Feel free to make other changes, but only the first is currently used in the functional tests. For these tests to pass, we will need to implement the model.</p>

  <h3 id="heading_id_4">Capturing the Order Details</h3>

  <p id="N1580A">Let’s implement the <code class="cf methodname">create</code> action in the controller. This method has to do the following:</p>

  <ol>
    <li>
      <p id="N15813">Capture the values from the form to populate a new <code class="cf class">Order</code> model object.</p>
    </li>

    <li>
      <p id="N1581A">Add the line items from our cart to that order.</p>
    </li>

    <li>
      <p id="N1581E">Validate and save the order. If this fails, display the appropriate messages, and let the user correct any problems.</p>
    </li>

    <li>
      <p id="N15822">Once the order is successfully saved, delete the cart, redisplay the catalog page, and display a message confirming that the order has been placed.</p>
    </li>
  </ol>

  <p id="N15825">First, we define the relationships themselves, first from the line item to the order:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/models/line_item.rb">rails31/depot_o/app/models/line_item.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> LineItem &lt; ActiveRecord::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">belongs_to :order</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">belongs_to :product</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">belongs_to :cart</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> total_price</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">product.price * quantity</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N15851">then from the order to the line item, once again indicating that all line items that belong to an order are to be destroyed whenever the order is destroyed:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/models/order.rb">rails31/depot_o/app/models/order.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> Order &lt; ActiveRecord::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">has_many :line_items, dependent: :destroy</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># ...</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N15875">The method itself ends up looking something like this:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/controllers/orders_controller.rb">rails31/depot_o/app/controllers/orders_controller.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> create</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@order = Order.new(params[:order])</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">@order.add_line_items_from_cart(current_cart)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">respond_to <strong class="prompt">do</strong> |format|</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> @order.save</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">Cart.destroy(session[:cart_id])</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">session[:cart_id] = nil</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.html { redirect_to store_url, notice:</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="string">'Thank you for your order.'</em> }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.json { render json: @order, status: :created,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">location: @order }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">@cart = current_cart</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.html { render action: <em class="string">"new"</em> }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">format.json { render json: @order.errors,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">status: :unprocessable_entity }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N158D2">We start by creating a new <code class="cf class">Order</code> object and initialize it from the form data. In this case, we want all the form data related to order objects, so we select the <code class="cf ic">:order</code> hash from the parameters (this is the name we passed as the first parameter to <code class="cf ic">form_for</code>). The next line adds into this order the items that are already stored in the cart&mdash;we’ll write the actual method to do this in a minute.</p>

  <div class="xxxsays">
    <div class="heading">
      <div class="persons-picture"><img alt="Joe asks:" src="../Images/joe.jpg" /></div>

      <div class="label">
        Joe asks:
      </div>

      <div class="title">
        Aren’t You Creating Duplicate Orders?
      </div>
    </div>

    <div class="body">
      <p id="N158E1">Joe is concerned to see our controller creating <code class="cf class">Order</code> model objects in two actions: <code class="cf ic">new</code> and <code class="cf ic">create</code>. He’s wondering why this doesn’t lead to duplicate orders in the database.</p>

      <p id="N158ED">The answer is simple: the <code class="cf ic">checkout</code> action creates an <code class="cf class">Order</code> object <span class="emph">in memory</span> simply to give the template code something to work with. Once the response is sent to the browser, that particular object gets abandoned, and it will eventually be reaped by Ruby’s garbage collector. It never gets close to the database.</p>

      <p id="N158F9">The <code class="cf ic">create</code> action also creates an <code class="cf class">Order</code> object, populating it from the form fields. This object <span class="emph">does</span> get saved in the database. So, model objects perform two roles: they map data into and out of the database, but they are also just regular objects that hold business data. They affect the database only when you tell them to, typically by calling <code class="cf methodname">save</code>.</p>
    </div>
  </div>

  <p id="N15908">Next we tell the order object to save itself (and its children, the line items) to the database. Along the way, the order object will perform validation (but we’ll get to that in a minute). If the save succeeds, we do two things. First, we ready ourselves for this customer’s next order by deleting the cart from the session. Then, we redisplay the catalog using the <code class="cf methodname">redirect_to</code> method to display a cheerful message. If, instead, the save fails, we set the <code class="cf ic">@cart</code> variable and redisplay the checkout form.</p>

  <p id="N15911">In the <code class="cf ic">create</code> action we assumed that the order object contains the method <code class="cf methodname">add_line_items_from_cart</code>, so let’s implement that method now:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_p/app/models/order.rb">rails31/depot_p/app/models/order.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> Order &lt; ActiveRecord::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># ...</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> add_line_items_from_cart(cart)</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">cart.line_items.each <strong class="prompt">do</strong> |item|</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">item.cart_id = nil</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">line_items &lt;&lt; item</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1594D">For each item that we transfer from the cart to the order, we need to do two things. First we set the <code class="cf ic">cart_id</code> to <code class="cf ic">nil</code> in order to prevent the item from going poof when we destroy the cart.</p>

  <p id="N15956">Then we add the item itself to the <code class="cf ic">line_items</code> collection for the order. Notice that we didn’t have to do anything special with the various foreign key fields, such as setting the <code class="cf sqlcolumn">order_id</code> column in the line item rows to reference the newly created order row. Rails does that knitting for us using the <code class="cf methodname">has_many</code> and <code class="cf methodname">belongs_to</code> declarations we added to the <code class="cf class">Order</code> and <code class="cf class">LineItem</code> models. Appending each new line item to the <code class="cf ic">line_items</code> collection hands the responsibility for key management over to Rails.</p>

  <p id="N1597E">We will also need to modify the test to reflect the new redirect:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_p/test/functional/orders_controller_test.rb">rails31/depot_p/test/functional/orders_controller_test.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">test <em class="string">"should create order"</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_difference(<em class="string">'Order.count'</em>) <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">post :create, order: @order.attributes</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_redirected_to store_path</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N159B3">So, as a first test of all of this, hit the <code class="cf keystroke">Place Order</code> button on the checkout page without filling in any of the form fields. You should see the checkout page redisplayed along with some error messages complaining about the empty fields, as shown in Figure 24, <a href="#fig.depot.p.full.house">​<em>Full house! Every field fails validation.</em>​</a>.</p>

  <p id="N159BC">If we fill in some data (as shown at the top of Figure 25, <a href="#fig.first.checkout">​<em>Entering order information produces a “Thanks!”</em>​</a>) and click <code class="cf keystroke">Place Order</code>, we should get taken back to the catalog, as shown at the bottom of the figure. But did it work? Let’s look in the database.</p>

  <table class="figure" id="fig.depot.p.full.house">
    <tr>
      <td><img alt="images/depot_p_full_house.png" src="../Images/depot_p_full_house.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 24. Full house! Every field fails validation.</b>
      </td>
    </tr>
  </table>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">sqlite3 -line db/development.sqlite3</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">SQLite version 3.7.4</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Enter ".help" for instructions</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">sqlite&gt; <strong class="prompt">select * from orders;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">id = 1</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">name = Dave Thomas</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">address = 123 Main St</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">email = customer@example.com</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">pay_type = Check</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">created_at = 2011-08-07 02:31:04.964785</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">updated_at = 2011-08-07 02:31:04.964785</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">sqlite&gt; <strong class="prompt">select * from line_items;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">id = 10</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">product_id = 2</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">cart_id =</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">created_at = 2011-08-07 02:30:26.188914</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">updated_at = 2011-08-07 02:31:04.966057</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">quantity = 1</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">price = 36</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">order_id = 1</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">sqlite&gt; <strong class="prompt">.quit</strong></code></td>
    </tr>
  </table>

  <p id="N15A27">Although what you see will differ on details such as version numbers and dates (and <code class="cf ic">price</code> will be present only if you completed the exercises defined in <a href="../Text/f_0064.html#sec.smartcart.playtime">​<em>Playtime</em>​</a>), you should see a single order and one or more line items that match your selections.</p>

  <table class="figure" id="fig.first.checkout">
    <tr>
      <td><img alt="images/depot_p_checkout_result.png" src="../Images/depot_p_checkout_result.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 25. Entering order information produces a “Thanks!”</b>
      </td>
    </tr>
  </table>

  <h3 id="heading_id_5">One Last Ajax Change</h3>

  <p id="N15A44">After we accept an order, we redirect to the index page, displaying the cheery flash message “Thank you for your order.” If the user continues to shop and they have JavaScript enabled in their browser, we’ll fill the cart in their sidebar without redrawing the main page. This means the flash message will continue to be displayed. We’d rather it went away after we add the first item to the cart (as it does when JavaScript is disabled in the browser). Fortunately, the fix is simple: we just hide the <code class="cf xmltag">&lt;div&gt;</code> that contains the flash message when we add something to the cart.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_p/app/views/line_items/create.js.erb">rails31/depot_p/app/views/line_items/create.js.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">$("#notice").hide();</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">if ($('#cart tr').length == 1) { $('#cart').show('blind', 1000); }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$('#cart').html("&lt;%=j render @cart %&gt;");</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$('#current_item').css({'background-color':'#88ff88'}).</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">animate({'background-color':'#114411'}, 1000);</code></td>
    </tr>
  </table>

  <p id="N15A68">Note that when we come to the store for the first time, there’s nothing in the flash, so the paragraph with an ID of <code class="cf ic">notice</code> isn’t displayed. Therefore, there’s no tag with the ID of <code class="cf ic">notice</code>, and the call to jQuery matches no elements. This is not a problem, as the call to <code class="cf methodname">hide</code> is applied to <span class="emph">each</span> matching element, so nothing happens. This is exactly what we want to happen, so all is well.</p>

  <p id="N15A77">Now that we’ve captured the order, it is time to alert the ordering department. We will do that with feeds, specifically, an Atom-formatted feed of orders.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
