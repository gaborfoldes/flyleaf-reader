<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="heading_id_2">11.6 Testing Ajax Changes</h2>

  <p id="N15115">We look at the test failures, and we see a number of errors that look like the following:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">ActionView::Template::Error: undefined method `line_items' for nil:NilClass</code></td>
    </tr>
  </table>

  <p id="N15136">Since this error represents the majority of the problems reported, let’s address it first so that we can focus on the rest. According to the test, we will have a problem if we get the product index, and sure enough, when we point our browser to <a href="http://localhost:3000/products/">http://localhost:3000/products/</a>, we see Figure 21, <a href="#fig.layout.error">​<em>An error in a layout can affect the entire application.</em>​</a>.</p>

  <table class="figure" id="fig.layout.error">
    <tr>
      <td><img alt="images/layout_failure.png" src="../Images/layout_failure.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 21. An error in a layout can affect the entire application.</b>
      </td>
    </tr>
  </table>

  <p id="N15148">This information is very helpful. The message identifies the template file was being processed at the point where the error occurs (<code class="cf ic">app/views/layouts/appli</code>-<code class="cf ic">cation.html.erb</code>), the line number where the error occurred, and an excerpt from the template of lines around the error. From this, we can see that the expression being evaluated at the point of error is <code class="cf ic">@cart.line_items</code>, and the message produced is <code class="cf ic">undefined method ‘line_items’ for nil</code>.</p>

  <p id="N15157">So, <code class="cf ic">@cart</code> is apparently <code class="cf ic">nil</code> when we display an index of our products. That makes sense, because it is set only in the store controller. This is easy enough to fix; all we need to do is avoid displaying the cart at all unless this value is set:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/app/views/layouts/application.html.erb">rails31/depot_o/app/views/layouts/application.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">if</strong> @cart %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= hidden_div_if(@cart.line_items.empty?, id: <em class="string">'cart'</em>) <strong class="prompt">do</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= render @cart %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>
  </table>

  <p id="N15187">After this fix, we rerun the tests again and see that we are down to one error. The value of the redirect was not what was expected. This occurred on creating a line item. Sure enough, we did change that on <a href="../Text/f_0066.html#sec.inlinecart">​<em>Changing the Flow</em>​</a>. Unlike the last change, which was entirely accidental, this change was intentional, so we update the corresponding functional test case:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/test/functional/line_items_controller_test.rb">rails31/depot_o/test/functional/line_items_controller_test.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">test <em class="string">"should create line_item"</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_difference(<em class="string">'LineItem.count'</em>) <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">post :create, product_id: products(:ruby).id</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_redirected_to store_path</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N151B5">With this change in place, our tests now once again pass. Just imagine what could have happened. A change in one part of an application in order to support a new requirement breaks a function we previously implemented in another part of the application. If you are not careful, this can happen in a small application like Depot. Even if you are careful, this will happen in a large application.</p>

  <p id="N151B8">But we are not done yet. We haven’t tested any of our Ajax additions, such as what happens when we click the <code class="cf keystroke">Add to Cart</code> button. Rails makes that easy too.</p>

  <p id="N151BE">We already have a test for <span class="emph">should create line item</span>, so let’s add another one called <span class="emph">should create line item via ajax</span>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/test/functional/line_items_controller_test.rb">rails31/depot_o/test/functional/line_items_controller_test.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">test <em class="string">"should create line_item via ajax"</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_difference(<em class="string">'LineItem.count'</em>) <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">xhr :post, :create, product_id: products(:ruby).id</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_response :success</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_select_jquery :html, <em class="string">'#cart'</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_select <em class="string">'tr#current_item td'</em>, /Programming Ruby 1.9/</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N15205">This test differs in the name of the test, in the manner of invocation from the create line item test (<code class="cf ic">xhr :post</code> vs. simply <code class="cf ic">post</code>, where <span class="emph">xhr</span> stands for the XMLHttpRequest mouthful), and in the expected results. Instead of a redirect, we expect a successful response containing a call to replace the HTML for the cart, and in that HTML we expect to find a row with an id of <code class="cf ic">current_item</code> with a value matching <code class="cf ic">Programming Ruby 1.9</code>. This is achieved by applying the <code class="cf methodname">assert_select_jquery</code> to extract the relevant HTML and then processing that HTML via whatever additional assertions you want to apply.</p>

  <p id="N1522D">Finally, there is the CoffeeScript that we introduced. While testing code that actually executes in the browser is outside the scope of this book, we should test that the markup that this script depends on is in place. And it is certainly easy enough:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_o/test/functional/store_controller_test.rb">rails31/depot_o/test/functional/store_controller_test.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">test <em class="string">"markup needed for store.js.coffee is in place"</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">get :index</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_select <em class="string">'.store .entry &gt; img'</em>, 3</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">assert_select <em class="string">'.entry input[type=submit]'</em>, 3</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N15254">This way, should an exuberant web designer change the markup on the page in a way that affects our logic, we will be alerted to this issue and be able to make a change before the code goes into production. Note that <code class="cf ic">:submit</code> is a jQuery-only extension to CSS; we simply need to spell out <code class="cf ic">input[type=submit]</code> in our test.</p>

  <p id="N1525D">Keeping tests up-to-date is an important part of maintaining your application. Rails makes this easy to do. Agile programmers make testing an integral part of their development efforts. Many even go so far as to write their tests first, before the first line of code is written.</p>

  <h3 id="heading_id_3">What We Just Did</h3>

  <p id="N15264">In this iteration, we added Ajax support to our cart:</p>

  <ul>
    <li>
      <p id="N1526A">We moved the shopping cart into the sidebar. We then arranged for the <code class="cf ic">create</code> action to redisplay the catalog page.</p>
    </li>

    <li>
      <p id="N15271">We used <code class="cf ic">remote: true</code> to invoke the <code class="cf class">LineItemsController</code>.<code class="cf methodname">create</code> action using Ajax.</p>
    </li>

    <li>
      <p id="N1527E">We then used an ERb template to create JavaScript that will execute on the client. This script made use of jQuery in order to update to the page with just the cart’s HTML.</p>
    </li>

    <li>
      <p id="N15282">To help the user see changes to the cart, we added a highlight effect, using the jQuery-UI library.</p>
    </li>

    <li>
      <p id="N15286">We wrote a helper method that hides the cart when it is empty, and used jQuery to reveal it when an item is added.</p>
    </li>

    <li>
      <p id="N1528A">We wrote a test that verifies not only the creation of a line item but also the content of the response that is returned from such a request.</p>
    </li>
  </ul>

  <p id="N1528D">The key point to take away is the incremental style of Ajax development. Start with a conventional application, and then add Ajax features, one by one. Ajax can be hard to debug: by adding it slowly to an application, you make it easier to track down what changed if your application stops working. And, as we saw, starting with a conventional application makes it easier to support both Ajax and non-Ajax behavior in the same codebase.</p>

  <p id="N15290">Finally, we’ll give you a couple of hints. First, if you plan to do a lot of Ajax development, you’ll probably need to get familiar with your browser’s JavaScript debugging facilities and with its DOM inspectors, such as Firefox’s Firebug, Internet Explorer 8’s Developer Tools, Google Chrome’s Developer Tools, Safari’s Web Inspector, or Opera’s Dragonfly. And, second, the NoScript plug-in for Firefox makes checking JavaScript/no JavaScript a one-click breeze. Others find it useful to run two different browsers when they are developing&mdash;with JavaScript enabled in one and disabled in the other. Then, as new features are added, poking at it with both browsers will make sure your application works regardless of the state of JavaScript.</p>

  <h3 id="heading_id_4">Playtime</h3>

  <p id="N152A6">Here’s some stuff to try on your own:</p>

  <ul>
    <li>
      <p id="N152AC">The cart is currently hidden when the user empties it by redrawing the entire catalog. Can you change the application to use the jQuery UI <code class="cf ic">blind</code> effect instead?</p>
    </li>

    <li>
      <p id="N152B3">Add a button next to each item in the cart. When clicked, it should invoke an action to decrement the quantity of the item, deleting it from the cart when the quantity reaches zero. Get it working without using Ajax first, and then add the Ajax goodness.</p>
    </li>
  </ul>

  <p id="N152B6">(You’ll find hints at <a href="http://www.pragprog.com/wikis/wiki/RailsPlayTime">http://www.pragprog.com/wikis/wiki/RailsPlayTime</a>.)</p>

  <div class="footnotes">
    <h4 id="heading_id_5">Footnotes</h4>

    <table cellspacing="3">
      <tr valign="top">
        <td class="footnote-number"><a href="../Text/f_0067.html#FNPTR-28" id="FOOTNOTE-28">[28]</a></td>

        <td>
          <p id="N14BB5"><a href="http://api.jquery.com/html/">http://api.jquery.com/html/</a></p>
        </td>
      </tr>

      <tr valign="top">
        <td class="footnote-number"><a href="../Text/f_0068.html#FNPTR-29" id="FOOTNOTE-29">[29]</a></td>

        <td>
          <p id="N14C5F"><a href="http://jqueryui.com/">http://jqueryui.com/</a></p>
        </td>
      </tr>

      <tr valign="top">
        <td class="footnote-number"><a href="../Text/f_0070.html#FNPTR-30" id="FOOTNOTE-30">[30]</a></td>

        <td>
          <p id="N150AD"><a href="http://jashkenas.github.com/coffee-script/">http://jashkenas.github.com/coffee-script/</a></p>
        </td>
      </tr>
    </table>
  </div>

  <div class="copyright">
    Copyright © 2011, The Pragmatic Bookshelf.
  </div><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
