<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="heading_id_2">11.5 Iteration F5: Making Images Clickable</h2>

  <p id="N14FF2">So far, we have only been doing things in response to a click, and only on things that are defined to be clickable (namely buttons and links). In this case what we want to do is to handle the onClick event for the image and have it execute some behavior that we define.</p>

  <p id="N14FF5">In other words, what we want to do is to have a script that executes when the page loads, and have it find all the images and associate logic with those images to forward the processing of click events to the <code class="cf keystroke">Add to Cart</code> button for the same entry.</p>

  <p id="N14FFB">First, we refresh our memory as to how the page in question is organized:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_n/app/views/store/index.html.erb">rails31/depot_n/app/views/store/index.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">if</strong> notice %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;p</strong> id=<em class="string">"notice"</em> <strong class="prompt">&gt;</strong>&lt;%= notice %&gt;<strong class="prompt">&lt;/p&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;h1&gt;</strong>Your Pragmatic Catalog<strong class="prompt">&lt;/h1&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% @products.each <strong class="prompt">do</strong> |product| %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"entry"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= image_tag(product.image_url) %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;h3&gt;</strong>&lt;%= product.title %&gt;<strong class="prompt">&lt;/h3&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= sanitize(product.description) %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> class=<em class="string">"price_line"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;span</strong> class=<em class="string">"price"</em> <strong class="prompt">&gt;</strong>&lt;%= number_to_currency(product.price) %&gt;<strong class="prompt">&lt;/span&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= button_to <em class="string">'Add to Cart'</em>, line_items_path(product_id: product),</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">remote: true %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>
  </table>

  <p id="N15078">Based on this information , we proceed by modifying <code class="cf filename">app/assets/javascripts/store.js.coffee</code>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_n/app/assets/javascripts/store.js.coffee">rails31/depot_n/app/assets/javascripts/store.js.coffee</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Place all the behaviors and hooks related to the matching controller here.</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># All this logic will automatically be available <strong class="prompt">in</strong> application.js.</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># You can use CoffeeScript <strong class="prompt">in</strong> this file: http:<em class="comment">//jashkenas.github.com/coffee-script/</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ -&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">$(<em class="string">'.store .entry &gt; img'</em>).click -&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">$(this).parent().find(<em class="string">':submit'</em>).click()</code></td>
    </tr>
  </table>

  <p id="N150A9">CoffeeScript<a href="../Text/f_0071.html#FOOTNOTE-30" id="FNPTR-30">[30]</a> is another preprocessor that makes writing assets easier. In this case, CoffeeScript helps you express JavaScript in a more concise form. Combined with JQuery, you can produce significant effects with very little effort.</p>

  <p id="N150B2">In this case, the first thing we want to do is to define a function that executes on page load. That’s what the first line of this script does: it defines a function using the <code class="cf ic">-&gt;</code> operator and passes it to a function named <code class="cf ic">$</code> which, as previously discussed, is aliased to <code class="cf ic">jQuery</code>. That’s all it takes to get jQuery to schedule the execution of these scripts when the page completes loading.</p>

  <p id="N150BE">The second line finds all images that are immediate children of elements that are defined with <code class="cf ic">class="entry</code>, which themselves are descendants of an element with <code class="cf ic">class="store"</code>. This last part is important as, just like with stylesheets, Rails will by default combine all JavaScripts into a single resource. For each image found, which could be zero when run against other pages in our application, a function is defined that is associated with the click event for that image.</p>

  <p id="N150C7">The third and final line processes that click event. It starts with the element on which the event occurred, namely <code class="cf ic">this</code>. It then proceeds to find the parent element, which will be the <code class="cf ic">div</code> that specifies <code class="cf ic">class="entry"</code>. Within that element we find the submit button, and we proceed to click it.</p>

  <p id="N150D3">Proceeding to the browser, the page looks no different than it did in Figure 19, <a href="../Text/f_0066.html#fig.depot.k.less.ugly">​<em>The cart is in the sidebar.</em>​</a>. But it behaves differently. Click on the images to cause items to be added to the cart. Marvel in the fact that all this was accomplished with a mere three lines of code.</p>

  <p id="N150D9">At this point, it occurs to us that we hadn’t really done much with respect to testing, but it doesn’t really feel like we’ve made much in the way of functional changes, so we should be fine. But just to be sure, we run our tests again:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rake test</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Loaded suite</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Started</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">...</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Finished in 0.458259 seconds.</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">7 tests, 28 assertions, 0 failures, 0 errors, 0 skips</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Loaded suite</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Started</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">...</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Finished in 1.048274 seconds.</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">23 tests, 26 assertions, 1 failures, 9 errors, 0 skips</code></td>
    </tr>
  </table>

  <p id="N1510E">Oh dear. Failures and errors. This is not good. Clearly, we need to revisit our approach to testing. In fact, we will do that next.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
