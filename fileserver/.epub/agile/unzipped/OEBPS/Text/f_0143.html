<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="sec.active.merchant">26.1 Credit Card Processing with Active Merchant</h2>

  <p id="N1FA74">Back <a href="../Text/f_0073.html#ask.credit.card">​here​</a> we mentioned that we were temporarily punting on the handling of credit cards. Being able to actually charge a customer is clearly an important part of taking an order. Although this functionality isn’t built into the core of Rails, there is a gem that provides this functionality for us.</p>

  <p id="N1FA8C">You’ve already seen how you control what gems get loaded by your application: you do this by editing your <code class="cf filename">Gemfile</code>. Since we are going to cover a number of such gems in this chapter, let’s go ahead and add all of the ones that we will cover at once. You can actually add these any place you like; we’ve chosen to do so immediately under the line adding the dependency on <code class="cf ic">will_paginate</code>.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_v/Gemfile">rails31/depot_v/Gemfile</a></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'activemerchant'</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'haml', '~&gt; 3.1.1'</code></td>
    </tr>
  </table>

  <p id="N1FAA3">You will note that we follow best practices by specifying a minimum version and effectively specifying an upper bound on the version number so that this demo will pick a version that is unlikely to contain an incompatible change.</p>

  <p id="N1FAA6">As for the gems we added, we will cover each in a separate section. This section will focus on Active Merchant.<a href="../Text/f_0145.html#FOOTNOTE-58" id="FNPTR-58">[58]</a></p>

  <p id="N1FAAE">Once you have edited your <code class="cf ic">Gemfile</code>, you can go ahead install these gems, as well as any gems that they depend on, via <code class="cf commandname">bundle install</code>. Additionally, if you have a Rails server up and running, restart it to pick up these changes. We won’t be using the server in this section but will shortly. Make sure that the server is running the Depot application.</p>

  <p id="N1FAB7">To demonstrate this functionality, we will create a small script, which we will place in the <code class="cf dir">script</code> directory:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_v/script/creditcard.rb">rails31/depot_v/script/creditcard.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">credit_card = ActiveMerchant::Billing::CreditCard.new(</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">number: <em class="string">'4111111111111111'</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">month: <em class="string">'8'</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">year: <em class="string">'2009'</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">first_name: <em class="string">'Tobias'</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">last_name: <em class="string">'Luetke'</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">verification_value: <em class="string">'123'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">puts <em class="string">"Is</em> #{credit_card.number} <em class="string">valid?</em> #{credit_card.valid?}<em class="string">"</em></code></td>
    </tr>
  </table>

  <p id="N1FAFC">There is not much to this script. It creates an instance of a <code class="cf class">ActiveMerchant::Bil</code> <code class="cf class">ling::CreditCard</code> class and then calls the <code class="cf methodname">valid?</code> on this object. Let’s run it.</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">rails runner script/creditcard.rb</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Is 4111111111111111 valid? false</code></td>
    </tr>
  </table>

  <p id="N1FB18">There’s not much to it; it just worked. Note that no <code class="cf ic">require</code> statements were necessary; simply listing the gem you want in your <code class="cf ic">Gemfile</code> makes the function available to your application.</p>

  <p id="N1FB21">At this point, you should be able to see how you could use this functionality in the Depot application. You know how to add a field to the <code class="cf ic">Orders</code> table via a migration. You know how to add that field to the view. You know how to add validation logic to your model, which calls the <code class="cf methodname">valid?</code> method that we used earlier. If you go to the merchant site, you can even find out how to <code class="cf methodname">authorize</code> and <code class="cf methodname">capture</code> a payment, though this does require you to have a login and a password with an existing commerce gateway. Once that is set up, you know how to call this logic from your controller.</p>

  <p id="N1FB30">Just think: all of that was made possible by the addition of a single line to your <code class="cf filename">Gemfile</code>.</p>

  <p id="N1FB36">As we stated at the beginning of this chapter, adding gems to your <code class="cf filename">Gemfile</code> is the preferred way to extend Rails 3.1. The advantages of doing so are numerous: all of your dependencies are tracked by Bundler, are all preloaded for immediate use by your application, and can be packed for easy deployment.</p>

  <p id="N1FB3C">At the time of this writing, the instructions for installing ActiveMerchant have not been updated on their website: they describe three other ways to install this function, depending on the version of Rails you are using. What we have described is the method you should use whenever possible.</p>

  <p id="N1FB54">This was a very simple addition. Let’s move on to something more significant: something that provides a clear alternative to one of the gems that Rails depends on.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
