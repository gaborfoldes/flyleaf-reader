<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="heading_id_2">15.1 Iteration J1: Selecting the Locale</h2>

  <p id="N173DB">We start by creating a new configuration file that encapsulates our knowledge of what locales are available and which one is to be used as the default.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_s/config/initializers/i18n.rb">rails31/depot_s/config/initializers/i18n.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">#encoding: utf-8</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">I18n.default_locale = :en</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">LANGUAGES = [</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">[<em class="string">'English'</em>, <em class="string">'en'</em>],</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">[<em class="string">"Espa&amp;ntilde;ol"</em>.html_safe, <em class="string">'es'</em>]</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">]</code></td>
    </tr>
  </table>

  <p id="N17427">This code is doing two things.</p>

  <p id="N1742A">The first thing it does is use the <code class="cf class">I18n</code> module to set the default locale. <code class="cf class">I18n</code> is a funny name, but it sure beats typing out <span class="emph">internationalization</span> all the time. Internationalization, after all, starts with an <span class="emph">i</span>, ends with an <span class="emph">n</span>, and has eighteen letters in between.</p>

  <p id="N17444">Then it defines a list of associations between display names and locale names. Unfortunately, all we have available at the moment is a U.S. keyboard, and español has a character that can’t be directly entered via our keyboard. Different operating systems have different ways of dealing with this, and often the easiest way is to simply copy and paste the correct text from a website. If you do this, just make sure your editor is configured for UTF-8. Meanwhile, we’ve opted to use the HTML equivalent of “n con tilde” character in Spanish. If we didn’t do anything else, the markup itself would be shown. But by calling <code class="cf ic">html_safe</code>, we inform Rails that the string is safe to be interpreted as containing HTML.</p>

  <p id="N17457">To get Rails to pick up this configuration change, the server needs to be restarted.</p>

  <p id="N1745A">Since each page that is translated will have an <code class="cf ic">en</code> and <code class="cf ic">es</code> version (for now, more will be added later), it makes sense to include this in the URL. Let’s plan to put the locale up front, make it optional, and have it default to the current locale, which in turn will default to English.</p>

  <p id="N17463">To implement this cunning plan, let’s start with modifying <code class="cf ic">config/routes.rb</code>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_s/config/routes.rb">rails31/depot_s/config/routes.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Depot::Application.routes.draw <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">get <em class="string">'admin'</em> =&gt; <em class="string">'admin#index'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">controller :sessions <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">get <em class="string">'login'</em> =&gt; :new</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">post <em class="string">'login'</em> =&gt; :create</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">delete <em class="string">'logout'</em> =&gt; :destroy</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">scope <em class="string">'(:locale)'</em> <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">resources :users</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">resources :orders</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">resources :line_items</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">resources :carts</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">resources :products <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">get :who_bought, on: :member</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">root to: <em class="string">'store#index'</em>, as: <em class="string">'store'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N174D4">What we have done is nested our resources and root declarations inside a scope declaration for <code class="cf ic">:locale</code>. Furthermore, <code class="cf ic">:locale</code> is in parentheses, which is the way to say that it is optional. Note that we did not choose to put the administrative and session functions inside this scope, because it is not our intent to translate them at this time.</p>

  <p id="N174E7">What this means is that both <a href="http://localhost:3000/">http://localhost:3000/</a> will use the default locale, namely, English, and therefore be routed exactly the same as <a href="http://localhost:3000/en">http://localhost:3000/en</a>. <a href="http://localhost:3000/es">http://localhost:3000/es</a> will route to the same controller and action, but we will want this to cause the locale to be set differently.</p>

  <p id="p.flash.now">To do this, we need to create a <code class="cf ic">before_filter</code> and to set the <code class="cf ic">default_url_options</code>. The logical place to do both is in the common base class for all of our controllers, which is <code class="cf ic">ApplicationController</code>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_s/app/controllers/application_controller.rb">rails31/depot_s/app/controllers/application_controller.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> ApplicationController &lt; ActionController::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">before_filter :set_i18n_locale_from_params</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># ...</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">protected</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> set_i18n_locale_from_params</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> params[:locale]</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> I18n.available_locales.include?(params[:locale].to_sym)</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">I18n.locale = params[:locale]</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">flash.now[:notice] =</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="string">"</em>#{params[:locale]} <em class="string">translation not available"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">logger.error flash.now[:notice]</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> default_url_options</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">{ locale: I18n.locale }</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N17575">This <code class="cf ic">set_i18n_locale_from_params</code> does pretty much what it says: it sets the locale from the params, but only if there is a locale in the params; otherwise, it leaves the current locale alone. Care is taken to provide a message for both the user and the administrator when there is a failure.</p>

  <p id="N1757B">And <code class="cf ic">default_url_options</code> also does pretty much what it says, in that it provides a hash of URL options that are to be considered as present whenever they aren’t otherwise provided. In this case, we are providing a value for the <code class="cf ic">:locale</code> parameter. This is needed when a view on a page that does not have the locale specified attempts to construct a link to a page that does. We will see that in use soon.</p>

  <p id="N17590">With this in place, we can see the results in Figure 31, <a href="#fig.i18n.base.en">​<em>English version of the front page</em>​</a>.</p>

  <table class="figure" id="fig.i18n.base.en">
    <tr>
      <td><img alt="images/english_translation.png" src="../Images/english_translation.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 31. English version of the front page</b>
      </td>
    </tr>
  </table>

  <p id="N1759F">At this point, the English version of the page is available both at the root of the website and at pages that start with <code class="cf ic">/en</code>. Additionally, a message on the screen says that the translation is not available (as we can see in Figure 32, <a href="#fig.i18n.trans.not.available">​<em>Translation not available</em>​</a>), which will also leave a message in the log indicating that the file wasn’t found. It might not look like it, but that’s progress.</p>

  <table class="figure" id="fig.i18n.trans.not.available">
    <tr>
      <td><img alt="images/i18n_trans_not_avail.png" src="../Images/i18n_trans_not_avail.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 32. Translation not available</b>
      </td>
    </tr>
  </table><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
