<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="heading_id_2">9.1 Iteration D1: Finding a Cart</h2>

  <p id="N136CB">As users browse our online catalog, they will (we hope) select products to buy. The convention is that each item selected will be added to a virtual shopping cart, held in our store. At some point, our buyers will have everything they need and will proceed to our site’s checkout, where they’ll pay for the stuff in the carts.</p>

  <p id="N136D5">This means that our application will need to keep track of all the items added to the cart by the buyer. To do that, we’ll keep a cart in the database and store its unique identifier, <code class="cf ic">cart.id</code>, in the session. Every time a request comes in, we can recover the identity from the session and use it to find the cart in the database.</p>

  <p id="N136E2">Let’s go ahead and create a cart:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rails generate scaffold cart</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">...</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rake db:migrate</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">== CreateCarts: migrating ====================================================</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">-- create_table(:carts)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">-&gt; <strong class="prompt">0.0012s</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">== CreateCarts: migrated (0.0014s) ===========================================</code></td>
    </tr>
  </table>

  <p id="N1370B">Rails makes the current session look like a hash to the controller, so we’ll store the id of the cart in the session by indexing it with the symbol <code class="cf ic">:cart_id</code>.</p>

  <table class="processedcode" id="page.find.cart">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_f/app/controllers/application_controller.rb">rails31/depot_f/app/controllers/application_controller.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> ApplicationController &lt; ActionController::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">protect_from_forgery</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">private</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> current_cart</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">Cart.find(session[:cart_id])</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">rescue</strong> ActiveRecord::RecordNotFound</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">cart = Cart.create</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">session[:cart_id] = cart.id</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">cart</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1374B">The <code class="cf methodname">current_cart</code> starts by getting the <code class="cf ic">:cart_id</code> from the <code class="cf ic">session</code> object and then attempts to find a cart corresponding to this id. If such a cart record is not found (which will happen if the id is <code class="cf ic">nil</code> or invalid for any reason), then this method will proceed to create a new <code class="cf class">Cart</code>, store the id of the created cart into the session, and then return the new cart.</p>

  <p id="N13761">Note that we place the <code class="cf methodname">current_cart</code> method in the <code class="cf class">ApplicationController</code> and mark it as private. This makes this method available only to controllers and furthermore prevents Rails from ever making it available as an action on the controller .</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
