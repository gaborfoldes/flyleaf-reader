<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  table.sgc-4 {padding: 2px; border-width: 0; border-style: none none none none;}
  td.sgc-3 {font-style:italic;}
  div.sgc-2 { margin-top: 6px; margin-bottom: 6px;}
  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="heading_id_2">20.2 Processing of Requests</h2>

  <p id="N1B1A9">In the previous section, we worked out how Action Dispatch routes an incoming request to the appropriate code in your application. Now let’s see what happens inside that code.</p>

  <h3 id="heading_id_3">Action Methods</h3>

  <p id="N1B1B0">When a controller object processes a request, it looks for a public instance method with the same name as the incoming action. If it finds one, that method is invoked. If it doesn’t find one and the controller implements <code class="cf methodname">method_missing</code>, that method is called, passing in the action name as the first parameter and an empty argument list as the second. If no method can be called, the controller looks for a template named after the current controller and action. If found, this template is rendered directly. If none of these things happens, an <code class="cf ic">AbstractController::ActionNotFound</code> error is generated.</p>

  <h4 id="heading_id_4">Controller Environment</h4>

  <p id="N1B1E2">The controller sets up the environment for actions (and, by extension, for the views that they invoke). Many of these methods provide direct access to information contained in the URL or request.</p>

  <dl>
    <dt class="force-newline"><code class="cf ic">action_name</code></dt>

    <dd>
      <p id="N1B1F3">The name of the action currently being processed.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">cookies</code></dt>

    <dd>
      <p id="N1B211">The cookies associated with the request. Setting values into this object stores cookies on the browser when the response is sent. Rails support for sessions is based on cookies. We discuss sessions <a href="../Text/f_0111.html#sec.sessions">​here​</a>.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">headers</code></dt>

    <dd>
      <p id="N1B221">A hash of HTTP headers that will be used in the response. By default, <code class="cf ic">Cache-Control</code> is set to <code class="cf ic">no-cache</code>. You might want to set <code class="cf ic">Content-Type</code> headers for special-purpose applications. Note that you shouldn’t set cookie values in the header directly&mdash;use the cookie API to do this.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">params</code></dt>

    <dd>
      <p id="N1B248">A hash-like object containing request parameters (along with pseudoparameters generated during routing). It’s hash-like because you can index entries using either a symbol or a string&mdash;<code class="cf ic">params[:id]</code> and <code class="cf ic">params[’id’]</code> return the same value. Idiomatic Rails applications use the symbol form.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">request</code></dt>

    <dd>
      <p id="N1B26C">The incoming request object. It includes these attributes:</p>

      <ul>
        <li>
          <p id="N1B287"><code class="cf ic">request_method</code> returns the request method, one of <code class="cf ic">:delete</code>, <code class="cf ic">:get</code>, <code class="cf ic">:head</code>, <code class="cf ic">:post</code>, or <code class="cf ic">:put</code>.</p>
        </li>

        <li>
          <p id="N1B2B1"><code class="cf ic">method</code> returns the same value as <code class="cf ic">request_method</code> except for <code class="cf ic">:head</code>, which it returns as <code class="cf ic">:get</code> because these two are functionally equivalent from an application point of view.</p>
        </li>

        <li>
          <p id="N1B2D5"><code class="cf ic">delete?</code>, <code class="cf ic">get?</code>, <code class="cf ic">head?</code>, <code class="cf ic">post?</code>, and <code class="cf ic">put?</code> return <code class="cf constant">true</code> or <code class="cf constant">false</code> based on the request method.</p>
        </li>

        <li>
          <p id="N1B324"><code class="cf ic">xml_http_request?</code> and <code class="cf ic">xhr?</code> return true if this request was issued by one of the Ajax helpers. Note that this parameter is independent of the <code class="cf ic">method</code> parameter.</p>
        </li>

        <li>
          <p id="N1B346"><code class="cf methodname">url</code>, which returns the full URL used for the request.</p>
        </li>

        <li>
          <p id="N1B361"><code class="cf methodname">protocol</code>, <code class="cf methodname">host</code>, <code class="cf methodname">port</code>, <code class="cf methodname">path</code>, and <code class="cf methodname">query_string</code>, which returns components of the URL used for the request, based on the following pattern: <code class="cf ic">protocol://host:port/path?query_string</code>.</p>
        </li>

        <li>
          <p id="N1B3DF"><code class="cf methodname">domain</code>, which returns the last two components of the domain name of the request.</p>
        </li>

        <li>
          <p id="N1B3FA"><code class="cf methodname">host_with_port</code>, which is a <code class="cf ic">host:port</code> string for the request.</p>
        </li>

        <li>
          <p id="N1B418"><code class="cf methodname">port_string</code>, which is a <code class="cf ic">:port</code> string for the request if the port is not the default port (80 for HTTP, 443 for HTTPS).</p>
        </li>

        <li>
          <p id="N1B436"><code class="cf methodname">ssl?</code>, which is <code class="cf ic">true</code> if this is an SSL request; in other words, the request was made with the HTTPS protocol.</p>
        </li>

        <li>
          <p id="N1B454"><code class="cf methodname">remote_ip</code>, which returns the remote IP address as a string. The string may have more than one address in it if the client is behind a proxy.</p>
        </li>

        <li>
          <p id="N1B46F"><code class="cf methodname">env</code>, the environment of the request. You can use this to access values set by the browser, such as this:</p>

          <table class="processedcode">
            <tr>
              <td class="codeprefix">&nbsp;</td>

              <td class="codeline"><code class="sgc-1">request.env[<em class="string">'HTTP_ACCEPT_LANGUAGE'</em>]</code></td>
            </tr>
          </table>
        </li>

        <li>
          <p id="N1B499"><code class="cf methodname">accepts</code>, which is an array with <code class="cf class">Mime::Type</code> objects that represent the MIME types in the <code class="cf ic">Accept</code> header.</p>
        </li>

        <li>
          <p id="N1B4A5"><code class="cf methodname">format</code>, which is computed based on the value of the <code class="cf ic">Accept</code> header, with <code class="cf ic">Mime::HTML</code> as a fallback.</p>
        </li>

        <li>
          <p id="N1B4C6"><code class="cf methodname">content_type</code>, which is the MIME type for the request. This is useful for <code class="cf ic">put</code> and <code class="cf ic">post</code> requests.</p>
        </li>

        <li>
          <p id="N1B4E7"><code class="cf methodname">headers</code>, which is the complete set of HTTP headers.</p>
        </li>

        <li>
          <p id="N1B502"><code class="cf methodname">body</code>, which is the request body as an I/O stream.</p>
        </li>

        <li>
          <p id="N1B51D"><code class="cf methodname">content_length</code>, which is the number of bytes purported to be in the body.</p>
        </li>
      </ul>

      <p id="N1B537">Rails leverages a gem named Rack to provide much of this functionality. See the documentation of <code class="cf class">Rack::Request</code> for full details.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">response</code></dt>

    <dd>
      <p id="N1B543">The response object, filled in during the handling of the request. Normally, this object is managed for you by Rails. As we’ll see when we look at filters <a href="../Text/f_0111.html#sec.filter">​here​</a>, we sometimes access the internals for specialized processing.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">session</code></dt>

    <dd>
      <p id="N1B56D">A hash-like object representing the current session data. We describe this <a href="../Text/f_0111.html#sec.sessions">​here​</a>.</p>
    </dd>
  </dl>

  <p id="N1B599">In addition, a <code class="cf ic">logger</code> is available throughout Action Pack.</p>

  <h4 id="heading_id_5">Responding to the User</h4>

  <p id="N1B5BF">Part of the controller’s job is to respond to the user. There are basically four ways of doing this:</p>

  <ul>
    <li>
      <p id="N1B5CC">The most common way is to render a template. In terms of the MVC paradigm, the template is the view, taking information provided by the controller and using it to generate a response to the browser.</p>
    </li>

    <li>
      <p id="N1B5D0">The controller can return a string directly to the browser without invoking a view. This is fairly rare but can be used to send error notifications.</p>
    </li>

    <li>
      <p id="N1B5D4">The controller can return nothing to the browser. This is sometimes used when responding to an Ajax request. In all cases, however, the controller returns a set of HTTP headers, because some kind of response is expected.</p>
    </li>

    <li>
      <p id="N1B5D8">The controller can send other data to the client (something other than HTML). This is typically a download of some kind (perhaps a PDF document or a file’s contents).</p>
    </li>
  </ul>

  <p id="N1B5DD">A controller always responds to the user exactly one time per request. This means that you should have just one call to a <code class="cf methodname">render</code>, <code class="cf methodname">redirect_to</code>, or <code class="cf ic">send_</code> <span class="emph">xxx</span> method in the processing of any request. (A <code class="cf class">DoubleRenderError</code> exception is thrown on the second render.)</p>

  <p id="N1B605">Because the controller must respond exactly once, it checks to see whether a response has been generated just before it finishes handling a request. If not, the controller looks for a template named after the controller and action and automatically renders it. This is the most common way that rendering takes place. You may have noticed that in most of the actions in our shopping cart tutorial we never explicitly rendered anything. Instead, our action methods set up the context for the view and return. The controller notices that no rendering has taken place and automatically invokes the appropriate template.</p>

  <p id="N1B608">You can have multiple templates with the same name but with different extensions (for example, <code class="cf ic">.html.erb</code>, <code class="cf ic">.xml.builder</code>, and <code class="cf ic">.js.rjs</code>). If you don’t specify an extension in a render request, Rails assumes <code class="cf ic">html.erb</code>.</p>

  <h4 id="heading_id_6">Rendering Templates</h4>

  <p id="N1B61C">A <span class="emph">template</span> is a file that defines the content of a response for our application. Rails supports three template formats out of the box: <span class="firstuseinline">erb</span>, which is embedded Ruby code (typically with HTML); <span class="firstuseinline">builder</span>, a more programmatic way of constructing XML content; and <span class="firstuseinline">RJS</span>, which generates JavaScript. We’ll talk about the contents of these files starting <a href="../Text/f_0113.html#sec.templates">​here​</a>.</p>

  <p id="N1B63A">By convention, the template for action <span class="emph">action</span> of controller <span class="emph">controller</span> will be in the file <code class="cf ic">app/views/<span class="emph">controller</span>/<span class="emph">action</span>.<span class="emph">type</span>.<span class="emph">xxx</span></code> (where <span class="emph">type</span> is the file type, such as <code class="cf ic">html</code>, <code class="cf ic">atom</code>, or <code class="cf ic">js</code>; and <span class="emph">xxx</span> is one of <code class="cf ic">erb</code>, <code class="cf ic">builder</code>, or <code class="cf ic">rjs</code>). The <code class="cf dir">app/views</code> part of the name is the default. You can override this for an entire application by setting this:</p>

  <p id="N1B681"><code class="cf ic">ActionController.prepend_view_path <span class="emph">dir_path</span></code></p>

  <p id="N1B687">The <code class="cf methodname">render</code> method is the heart of all rendering in Rails. It takes a hash of options that tell it what to render and how to render it.</p>

  <p id="N1B698">It is tempting to write code in our controllers that looks like this:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># DO NOT DO THIS</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> update</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@user = User.find(params[:id])</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> @user.update_attributes(params[:user])</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">render :action =&gt; show</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">render :template =&gt; <em class="string">"fix_user_errors"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1B6C6">It seems somehow natural that the act of calling <code class="cf ic">render</code> (and <code class="cf ic">redirect_to</code>) should somehow terminate the processing of an action. This is not the case. The previous code will generate an error (because <code class="cf ic">render</code> is called twice) in the case where <code class="cf ic">update_attributes</code> succeeds.</p>

  <p id="N1B6D5">Let’s look at the render options used in the controller here (we’ll look separately at rendering in the view starting <a href="../Text/f_0118.html#sec.partial.template">​here​</a>):</p>

  <dl>
    <dt class="force-newline"><code class="cf ic">render()</code></dt>

    <dd>
      <p id="N1B6E2">With no overriding parameter, the <code class="cf methodname">render</code> method renders the default template for the current controller and action. The following code will render the template <code class="cf filename">app/views/blog/index.html.erb</code>:</p>

      <table class="processedcode">
        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> BlogController &lt; ApplicationController</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> index</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">render</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>
      </table>

      <p id="N1B70A">So will the following (as the default behavior of a controller is to call <code class="cf methodname">render</code> if the action doesn’t):</p>

      <table class="processedcode">
        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> BlogController &lt; ApplicationController</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> index</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>
      </table>

      <p id="N1B72C">And so will this (because the controller will call a template directly if no action method is defined):</p>

      <table class="processedcode">
        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> BlogController &lt; ApplicationController</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>
      </table>
    </dd>

    <dt class="force-newline"><code class="cf ic">render(:text =&gt; <span class="emph">string</span>)</code></dt>

    <dd>
      <p id="N1B749">Sends the given string to the client. No template interpretation or HTML escaping is performed.</p>

      <table class="processedcode">
        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> HappyController &lt; ApplicationController</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> index</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">render(:text =&gt; <em class="string">"Hello there!"</em>)</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>
      </table>
    </dd>

    <dt class="force-newline"><code class="cf ic">render(:inline =&gt; <span class="emph">string</span>, [ :type =&gt; <span class="emph">"erb"|"builder"|"rjs"</span> ], [ :locals =&gt; <span class="emph">hash</span>] )</code></dt>

    <dd>
      <p id="N1B795">Interprets&nbsp;<span class="emph">string</span> as the source to a template of the given type, rendering the results back to the client. You can use the <code class="cf ic">:locals</code> hash to set the values of local variables in the template.</p>

      <p id="N1B7B6">The following code adds <code class="cf methodname">method_missing</code> to a controller if the application is running in development mode. If the controller is called with an invalid action, this renders an inline template to display the action’s name and a formatted version of the request parameters.</p>

      <table class="processedcode">
        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> SomeController &lt; ApplicationController</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> RAILS_ENV == <em class="string">"development"</em></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> method_missing(name, *args)</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">render(:inline =&gt; <em class="string">%{</em></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><em class="string">&lt;h2&gt;Unknown action:</em> #{name}<em class="string">&lt;/h2&gt;</em></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><em class="string">Here are the request parameters:&lt;br/&gt;</em></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><em class="string">&lt;%= debug(params) %&gt; }</em>)</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>
      </table>
    </dd>

    <dt class="force-newline"><code class="cf ic">render(:action =&gt; <span class="emph">action_name</span>)</code></dt>

    <dd>
      <p id="N1B818">Renders the template for a given action in this controller. Sometimes folks use the <code class="cf ic">:action</code> form of <code class="cf methodname">render</code> when they should use redirects. See the discussion starting <a href="#sec.redirect">​here​</a> for why this is a bad idea.</p>

      <table class="processedcode">
        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> display_cart</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> @cart.empty?</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">render(:action =&gt; :index)</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><em class="comment"># ...</em></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>
      </table>

      <p id="N1B865">Note that calling <code class="cf ic">render(:action...)</code> does not call the action method; it simply displays the template. If the template needs instance variables, these must be set up by the method that calls the <code class="cf methodname">render</code> method.</p>

      <p id="N1B86E">Let’s repeat this, because this is a mistake that beginners often make: calling <code class="cf ic">render(:action...)</code> does not invoke the action method. It simply renders that action’s default template.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">render(:template =&gt; <span class="emph">name</span>, [:locals =&gt; <span class="emph">hash</span>] )</code></dt>

    <dd>
      <p id="N1B880">Renders a template and arranges for the resulting text to be sent back to the client. The <code class="cf ic">:template</code> value must contain both the controller and action parts of the new name, separated by a forward slash. The following code will render the template <code class="cf filename">app/views/blog/short_list</code>:</p>

      <table class="processedcode">
        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> BlogController &lt; ApplicationController</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> index</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">render(:template =&gt; <em class="string">"blog/short_list"</em>)</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>
      </table>
    </dd>

    <dt class="force-newline"><code class="cf ic">render(:partial =&gt; <span class="emph">name</span>, …)</code></dt>

    <dd>
      <p id="N1B8CC">Renders a partial template. We talk about partial templates in depth <a href="../Text/f_0118.html#sec.partial.template">​here​</a>.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">render(:nothing =&gt; true)</code></dt>

    <dd>
      <p id="N1B8F0">Returns nothing&mdash;sends an empty body to the browser.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">render(:xml =&gt; <span class="emph">stuff</span>)</code></dt>

    <dd>
      <p id="N1B914">Renders <span class="emph">stuff</span> as text, forcing the content type to be <code class="cf ic">application/xml</code>.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">render(:json =&gt; <span class="emph">stuff</span>, [:callback =&gt; <span class="emph">hash</span>] )</code></dt>

    <dd>
      <p id="N1B941">Renders <span class="emph">stuff</span> as JSON, forcing the content type to be <code class="cf ic">application/json</code>. Specifying <code class="cf ic">:callback</code> will cause the result to be wrapped in a call to the named callback function.</p>
    </dd>

    <dt class="force-newline"><code class="cf ic">render(:update) do |page| ... end</code></dt>

    <dd>
      <p id="N1B970">Renders the block as an RJS template, passing in the page object.</p>

      <table class="processedcode">
        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">render(:update) <strong class="prompt">do</strong> |page|</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">page[:cart].replace_html :partial =&gt; <em class="string">'cart'</em>, :object =&gt; @cart</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1">page[:cart].visual_effect :blind_down <strong class="prompt">if</strong> @cart.total_items == 1</code></td>
        </tr>

        <tr>
          <td class="codeprefix">&nbsp;</td>

          <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
        </tr>
      </table>
    </dd>
  </dl>

  <p id="N1B9B1">All forms of <code class="cf methodname">render</code> take optional <code class="cf ic">:status</code>, <code class="cf ic">:layout</code>, and <code class="cf ic">:content_type</code> parameters. The <code class="cf ic">:status</code> parameter provides the value used in the status header in the HTTP response. It defaults to <code class="cf ic">"200&nbsp;OK"</code>. Do not use <code class="cf methodname">render</code> with a 3xx status to do redirects; Rails has a <code class="cf methodname">redirect</code> method for this purpose.</p>

  <p id="N1B9E9">The <code class="cf ic">:layout</code> parameter determines whether the result of the rendering will be wrapped by a layout (we first came across layouts <a href="../Text/f_0052.html#sec.depot.layouts">​here​</a>, and we’ll look at them in depth starting <a href="../Text/f_0118.html#sec.layouts">​here​</a>). If the parameter is <code class="cf ic">false</code>, no layout will be applied. If set to <code class="cf constant">nil</code> or <code class="cf constant">true</code>, a layout will be applied only if there is one associated with the current action. If the <code class="cf ic">:layout</code> parameter has a string as a value, it will be taken as the name of the layout to use when rendering. A layout is never applied when the <code class="cf ic">:nothing</code> option is in effect.</p>

  <p id="N1BA1B">The <code class="cf ic">:content_type</code> parameter lets you specify a value that will be passed to the browser in the Content-Type HTTP header.</p>

  <p id="N1BA3E">Sometimes it is useful to be able to capture what would otherwise be sent to the browser in a string. The <code class="cf methodname">render_to_string</code> method takes the same parameters as <code class="cf methodname">render</code> but returns the result of rendering as a string&mdash;the rendering is not stored in the response object and so will not be sent to the user unless you take some additional steps. Calling <code class="cf ic">render_to_string</code> does not count as a real render. You can invoke the real <code class="cf ic">render</code> method later without getting a <code class="cf class">DoubleRender</code> error.</p>

  <h4 id="sec.send.data">Sending Files and Other Data</h4>

  <p id="N1BA6D">We’ve looked at rendering templates and sending strings in the controller. The third type of response is to send data (typically, but not necessarily, file contents) to the client.</p>

  <div>
    <h3 id="heading_id_7">send_data</h3>

    <div>
      Sends a string containing binary data to the client.
    </div>

    <div class="codeline sgc-2">
      send_data(<span class="emph">data, options…</span>)
    </div>

    <p id="N1BA85">Sends a data stream to the client. Typically the browser will use a combination of the content type and the disposition, both set in the options, to determine what to do with this data.</p>

    <table class="processedcode">
      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> sales_graph</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">png_data = Sales.plot_for(Date.today.month)</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">send_data(png_data, :type =&gt; <em class="string">"image/png"</em>, :disposition =&gt; <em class="string">"inline"</em>)</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
      </tr>
    </table>

    <div class="b">
      Options:
    </div>

    <table class="sgc-4">
      <tr>
        <td valign="top">:disposition</td>

        <td class="sgc-3" valign="top">string</td>

        <td valign="top">Suggests to the browser that the file should be displayed inline (option <code class="cf ic">inline</code>) or downloaded and saved (option <code class="cf ic">attachment</code>, the default).</td>
      </tr>

      <tr>
        <td valign="top">:filename</td>

        <td class="sgc-3" valign="top">string</td>

        <td valign="top">A suggestion to the browser of the default filename to use when saving this data.</td>
      </tr>

      <tr>
        <td valign="top">:status</td>

        <td class="sgc-3" valign="top">string</td>

        <td valign="top">The status code (defaults to <code class="cf ic">"200 OK"</code>).</td>
      </tr>

      <tr>
        <td valign="top">:type</td>

        <td class="sgc-3" valign="top">string</td>

        <td valign="top">The content type, defaulting to <code class="cf ic">application/octet-stream</code>.</td>
      </tr>

      <tr>
        <td valign="top">:url_based_filename</td>

        <td class="sgc-3" valign="top">boolean</td>

        <td valign="top">If <code class="cf ic">true</code> and <code class="cf ic">:filename</code> is not set, prevents Rails from providing the basename of the file in the Content-Disposition header. Specifying this is necessary in order to make some browsers handle i18n filenames correctly.</td>
      </tr>
    </table>
  </div>

  <div>
    <h3 id="heading_id_8">send_file</h3>

    <div>
      Sends the contents of a file to the client.
    </div>

    <div class="codeline sgc-2">
      send_file(<span class="emph">path, options…</span>)
    </div>

    <p id="N1BB9B">Sends the given file to the client. The method sets the Content-Length, Content-Type, Content-Disposition, and Content-Transfer-Encoding headers.</p>

    <div class="b">
      Options:
    </div>

    <table class="sgc-4">
      <tr>
        <td valign="top">:buffer_size</td>

        <td class="sgc-3" valign="top">number</td>

        <td valign="top">The amount sent to the browser in each write if streaming is enabled (<code class="cf ic">:stream</code> is true).</td>
      </tr>

      <tr>
        <td valign="top">:disposition</td>

        <td class="sgc-3" valign="top">string</td>

        <td valign="top">Suggests to the browser that the file should be displayed inline (option <code class="cf ic">inline</code>) or downloaded and saved (option <code class="cf ic">attachment</code>, the default).</td>
      </tr>

      <tr>
        <td valign="top">:filename</td>

        <td class="sgc-3" valign="top">string</td>

        <td valign="top">A suggestion to the browser of the default filename to use when saving the file. If not set, defaults to the filename part of <span class="emph">path</span>.</td>
      </tr>

      <tr>
        <td valign="top">:status</td>

        <td class="sgc-3" valign="top">string</td>

        <td valign="top">The status code (defaults to <code class="cf ic">"200 OK"</code>).</td>
      </tr>

      <tr>
        <td valign="top">:stream</td>

        <td class="sgc-3" valign="top">true or false</td>

        <td valign="top">If <code class="cf constant">false</code>, the entire file is read into server memory and sent to the client. Otherwise, the file is read and written to the client in <code class="cf ic">:buffer_size</code> chunks.</td>
      </tr>

      <tr>
        <td valign="top">:type</td>

        <td class="sgc-3" valign="top">string</td>

        <td valign="top">The content type, defaulting to <code class="cf ic">application/octet-stream</code>.</td>
      </tr>
    </table>
  </div>

  <p id="N1BC4F">You can set additional headers for either <code class="cf ic">send_</code> method using the <code class="cf ic">headers</code> attribute in the controller.</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> send_secret_file</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">send_file(<em class="string">"/files/secret_list"</em>)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">headers[<em class="string">"Content-Description"</em>] = <em class="string">"Top secret"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1BC8C">We show how to upload files starting <a href="../Text/f_0116.html#sec.file.upload">​here​</a>.</p>

  <h4 id="sec.redirect">Redirects</h4>

  <p id="N1BC97">An HTTP redirect is sent from a server to a client in response to a request. In effect, it says, “I can’t handle this request, but here’s some URL that can.” The redirect response includes a URL that the client should try next along with some status information saying whether this redirection is permanent (status code 301) or temporary (307). Redirects are sometimes used when web pages are reorganized; clients accessing pages in the old locations will get referred to the page’s new home. More commonly, Rails applications use redirects to pass the processing of a request off to some other action.</p>

  <p id="N1BCAB">Redirects are handled behind the scenes by web browsers. Normally, the only way you’ll know that you’ve been redirected is a slight delay and the fact that the URL of the page you’re viewing will have changed from the one you requested. This last point is important&mdash;as far as the browser is concerned, a redirect from a server acts pretty much the same as having an end user enter the new destination URL manually.</p>

  <p id="N1BCAE">Redirects turn out to be important when writing well-behaved web applications. Let’s look at a simple blogging application that supports comment posting. After a user has posted a comment, our application should redisplay the article, presumably with the new comment at the end.</p>

  <p id="N1BCB1">It’s tempting to code this using logic such as the following:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> BlogController</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> display</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@article = Article.find(params[:id])</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> add_comment</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@article = Article.find(params[:id])</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">comment = Comment.new(params[:comment])</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@article.comments &lt;&lt; comment</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> @article.save</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">flash[:note] = <em class="string">"Thank you for your valuable comment"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">flash[:note] = <em class="string">"We threw your worthless comment away"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># DON'T DO THIS</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">render(:action =&gt; <em class="string">'display'</em>)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1BD0F">The intent here was clearly to display the article after a comment has been posted. To do this, the developer ended the <code class="cf methodname">add_comment</code> method with a call to <code class="cf methodname">render(:action=&gt;'display')</code>. This renders the <code class="cf ic">display</code> view, showing the updated article to the end user. But think of this from the browser’s point of view. It sends a URL ending in <code class="cf ic">blog/add_comment</code> and gets back an index listing. As far as the browser is concerned, the current URL is still the one that ends in <code class="cf ic">blog/add_comment</code>. This means that if the user hits Refresh or Reload (perhaps to see whether anyone else has posted a comment), the <code class="cf ic">add_comment</code> URL will be sent again to the application. The user intended to refresh the display, but the application sees a request to add another comment. In a blog application, this kind of unintentional double entry is inconvenient. In an online store, it can get expensive.</p>

  <p id="N1BD25">In these circumstances, the correct way to show the added comment in the index listing is to redirect the browser to the <code class="cf ic">display</code> action. We do this using the Rails <code class="cf methodname">redirect_to</code> method. If the user subsequently hits Refresh, it will simply reinvoke the <code class="cf ic">display</code> action and not add another comment:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> add_comment</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@article = Article.find(params[:id])</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">comment = Comment.new(params[:comment])</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@article.comments &lt;&lt; comment</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> @article.save</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">flash[:note] = <em class="string">"Thank you for your valuable comment"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">flash[:note] = <em class="string">"We threw your worthless comment away"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">redirect_to(:action =&gt; <em class="string">'display'</em>)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1BD76">Rails has a simple yet powerful redirection mechanism. It can redirect to an action in a given controller (passing parameters), to a URL (on or off the current server), or to the previous page. Let’s look at these three forms in turn.</p>

  <div>
    <h3 id="heading_id_9">redirect_to</h3>

    <div>
      Redirects to an action.
    </div>

    <div class="codeline sgc-2">
      redirect_to(:action =&gt; ..., <span class="emph">options…</span>)
    </div>

    <p id="N1BD83">Sends a temporary redirection to the browser based on the values in the <code class="cf ic">options</code> hash. The target URL is generated using <code class="cf methodname">url_for</code>, so this form of <code class="cf methodname">redirect_to</code> has all the smarts of Rails routing code behind it.</p>
  </div>

  <div>
    <h3 id="heading_id_10">redirect_to</h3>

    <div>
      Redirects to a URL.
    </div>

    <div class="codeline sgc-2">
      redirect_to(<span class="emph">path</span>)
    </div>

    <p id="N1BDA5">Redirects to the given path. If the path does not start with a protocol (such as <code class="cf ic">http://</code>), the protocol and port of the current request will be prepended. This method does not perform any rewriting on the URL, so it should not be used to create paths that are intended to link to actions in the application (unless you generate the path using <code class="cf ic">url_for</code> or a named route URL generator).</p>

    <table class="processedcode">
      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> save</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">order = Order.new(params[:order])</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> order.save</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">redirect_to :action =&gt; <em class="string">"display"</em></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">session[:error_count] ||= 0</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">session[:error_count] += 1</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> session[:error_count] &lt; 4</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">self.notice = <em class="string">"Please try again"</em></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><em class="comment"># Give up -- user is clearly struggling</em></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">redirect_to(<em class="string">"/help/order_entry.html"</em>)</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
      </tr>
    </table>
  </div>

  <div>
    <h3 id="heading_id_11">redirect_to</h3>

    <div>
      Redirects to the referrer.
    </div>

    <div class="codeline sgc-2">
      redirect_to(:back)
    </div>

    <p id="N1BE04">Redirects to the URL given by the <code class="cf ic">HTTP_REFERER</code> header in the current request.</p>

    <table class="processedcode">
      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> save_details</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">unless</strong> params[:are_you_sure] == <em class="string">'Y'</em></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">redirect_to(:back)</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1">...</code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
      </tr>

      <tr>
        <td class="codeprefix">&nbsp;</td>

        <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
      </tr>
    </table>
  </div>

  <p id="N1BE4A">By default all redirections are flagged as temporary (they will affect only the current request). When redirecting to a URL, it’s possible you might want to make the redirection permanent. In that case, set the status in the response header accordingly:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">headers[<em class="string">"Status"</em>] = <em class="string">"301 Moved Permanently"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">redirect_to(<em class="string">"http://my.new.home"</em>)</code></td>
    </tr>
  </table>

  <p id="N1BE78">Because redirect methods send responses to the browser, the same rules apply as for the rendering methods&mdash;you can issue only one per request.</p>

  <p id="N1BE7B">So far, we have been looking at requests and responses in isolation. Rails also provides a number of mechanisms that span requests.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
