<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="heading_id_2">15.4 Iteration J4: Add a Locale Switcher</h2>

  <p id="N17D7E">We’ve completed the task, but we really need to advertise its availability more. We spy some unused area in the top-right side of the layout, so we add a form immediately before the <code class="cf ic">image_tag</code>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_t/app/views/layouts/application.html.erb">rails31/depot_t/app/views/layouts/application.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;div</strong> id=<em class="string">"banner"</em> <strong class="prompt">&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= form_tag store_path, class: <em class="string">'locale'</em> <strong class="prompt">do</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= select_tag <em class="string">'set_locale'</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">options_for_select(LANGUAGES, I18n.locale.to_s),</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">onchange: <em class="string">'this.form.submit()'</em> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= submit_tag <em class="string">'submit'</em> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= javascript_tag <em class="string">"$('.locale input').hide()"</em> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= image_tag(<em class="string">"logo.png"</em>) %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= @page_title || t(<em class="string">'.title'</em>) %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/div&gt;</strong></code></td>
    </tr>
  </table>

  <p id="N17DD6">The <code class="cf ic">form_tag</code> specifies the path to the store as the page to be redisplayed when the form is submitted. A <code class="cf ic">class</code> attribute lets us associate the form with some CSS.</p>

  <p id="N17DE7">The <code class="cf ic">select_tag</code> is used to define the one input field for this form, namely, locale. It is an options list based on the <code class="cf constant">LANGUAGES</code> array that we set up in the configuration file, with the default being the current locale (also made available via the <code class="cf class">I18n</code> module). We also set up an <code class="cf ic">onchange</code> event handler, which will submit this form whenever the value changes. This works only if JavaScript is enabled, but it is handy.</p>

  <p id="N17E04">Then we add a <code class="cf ic">submit_tag</code> for the cases when JavaScript is not available. To handle the case where JavaScript is available and the submit button is unnecessary, we add a tiny bit of JavaScript that will hide each of the input tags in the locale form, even though we know that there is only one.</p>

  <p id="N17E18">Next, we modify the store controller to redirect to the store path for a given locale if the <code class="cf ic">:set_locale</code> form is used:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_t/app/controllers/store_controller.rb">rails31/depot_t/app/controllers/store_controller.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> index</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> params[:set_locale]</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">redirect_to store_path(locale: params[:set_locale])</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">@products = Product.order(:title)</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">@cart = current_cart</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N17E49">Finally, we add a bit of CSS:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_t/app/assets/stylesheets/application.css.scss">rails31/depot_t/app/assets/stylesheets/application.css.scss</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">.locale {</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">float: right;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">margin: -0.25em 0.1em;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">}</code></td>
    </tr>
  </table>

  <p id="N17E61">For the actual selector, see Figure 40, <a href="#fig.i18n.selector">​<em>Locale selector in top right</em>​</a>. We can now switch back and forth between languages with a single mouse click.</p>

  <table class="figure" id="fig.i18n.selector">
    <tr>
      <td><img alt="images/i18n_selector.png" src="../Images/i18n_selector.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 40. Locale selector in top right</b>
      </td>
    </tr>
  </table>

  <p id="N17E75">At this point, we can now place orders in two languages, and our thoughts turn to actual deployment. But because it has been a busy day, it is time to put down our tools and relax. We will start on deployment in the morning.</p>

  <h3 id="heading_id_3">What We Just Did</h3>

  <p id="N17E96">By the end of this iteration, we’ve done the following:</p>

  <ul>
    <li>
      <p id="N17E9C">We set the default locale for our application and provided a means for the user to select an alternate locale.</p>
    </li>

    <li>
      <p id="N17EA0">We created translation files for text fields, currency amounts, errors, and model names.</p>
    </li>

    <li>
      <p id="N17EA4">We altered layouts and views to call out to the <code class="cf class">I18n</code> module by way of the <code class="cf methodname">t</code> helper in order to translate textual portions of the interface.</p>
    </li>
  </ul>

  <h3 id="heading_id_4">Playtime</h3>

  <p id="N17EB1">Here’s some stuff to try on your own:</p>

  <ul>
    <li>
      <p id="N17EB7">Add a locale column to the products database, and adjust the index view to select only the products that match the locale. Adjust the products view so that you can view, enter, and alter this new column. Enter a few products in each locale, and test the resulting application.</p>
    </li>

    <li>
      <p id="N17EBB">Determine the current exchange rate between U.S. dollars and euros, and localize the currency display to display euros when <code class="cf ic">ES_es</code> is selected.</p>
    </li>

    <li>
      <p id="N17EC2">Translate the <code class="cf ic">Order::PAYMENT_TYPES</code> shown in the drop-down. You will need to keep the option value (which is sent to the server) the same. Only change what is displayed.</p>
    </li>
  </ul>

  <p id="N17EC8">(You’ll find hints at <a href="http://www.pragprog.com/wikis/wiki/RailsPlayTime">http://www.pragprog.com/wikis/wiki/RailsPlayTime</a>.)</p>

  <div class="copyright">
    Copyright © 2011, The Pragmatic Bookshelf.
  </div><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
