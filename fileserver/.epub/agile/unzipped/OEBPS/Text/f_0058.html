<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="heading_id_2">9.2 Iteration D2: Connecting Products to Carts</h2>

  <p id="N13781">We’re looking at sessions because we need somewhere to keep our shopping cart. We’ll cover sessions in more depth in <a href="../Text/f_0111.html#sec.sessions">​<em>Rails Sessions</em>​</a>, but for now let’s move on to implement the cart.</p>

  <p id="N13787">Let’s keep things simple. A cart contains a set of products. Based on the diagram <a href="../Text/f_0041.html#fig.initial.data">​here​</a>, combined with a brief chat with our customer, we can now generate the Rails models and populate the migrations to create the corresponding tables:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rails generate scaffold line_item product_id:integer cart_id:integer</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">...</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">rake db:migrate</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">== CreateLineItems: migrating ================================================</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">-- create_table(:line_items)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">-&gt; <strong class="prompt">0.0013s</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">== CreateLineItems: migrated (0.0014s) =======================================</code></td>
    </tr>
  </table>

  <p id="N137B3">The database now has a place to store the relationships between line items, carts, and products. However, the Rails application does not. We need to add some declarations to our model files that specify their interrelationships.</p>

  <p id="N137B6">Open the newly created <code class="cf filename">cart.rb</code> file in <code class="cf dir">app/models</code>, and add a call to <code class="cf methodname">has_many</code>:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_f/app/models/cart.rb">rails31/depot_f/app/models/cart.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> Cart &lt; ActiveRecord::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">has_many :line_items, dependent: :destroy</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N137E3">That <code class="cf ic">has_many :line_items</code> part of the directive is fairly self-explanatory: a cart (potentially) has many associated line items. These are linked to the cart because each line item contains a reference to its cart’s id. The <code class="cf ic">dependent: :destroy</code> part indicates that the existence of line items is dependent on the existence of the cart. If we destroy a cart, deleting it from the database, we’ll want Rails also to destroy any line items that are associated with that cart.</p>

  <p id="N137F9">Next, we’ll specify links in the opposite direction, from the line item to the <code class="cf sqltable">carts</code> and <code class="cf sqltable">products</code> tables. To do this, we use the <code class="cf methodname">belongs_to</code> declaration twice in the <code class="cf filename">line_item.rb</code> file:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_f/app/models/line_item.rb">rails31/depot_f/app/models/line_item.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> LineItem &lt; ActiveRecord::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">belongs_to :product</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">belongs_to :cart</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1382C"><code class="cf ic">belongs_to</code> tells Rails that rows in the <code class="cf sqltable">line_items</code> table are children of rows in the <code class="cf sqltable">carts</code> and <code class="cf sqltable">products</code> tables. No line item can exist unless the corresponding cart and product rows exist. There’s an easy way to remember where to put <code class="cf ic">belongs_to</code> declarations: if a table has foreign keys, the corresponding model should have a <code class="cf ic">belongs_to</code> for each.</p>

  <p id="N13850">Just what do these various declarations do? Basically, they add navigation capabilities to the model objects. Because we added the <code class="cf ic">belongs_to</code> declaration to <code class="cf class">LineItem</code>, we can now retrieve its <code class="cf class">Product</code> and display the book’s title:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">li = LineItem.find(...)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">puts <em class="string">"This line item is for</em> #{li.product.title}<em class="string">"</em></code></td>
    </tr>
  </table>

  <p id="N1386F">And because <code class="cf class">Cart</code> is declared to have many line items, we can reference them (as a collection) from a cart object:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">cart = Cart.find(...)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">puts <em class="string">"This cart has</em> #{cart.line_items.count} <em class="string">line items"</em></code></td>
    </tr>
  </table>

  <p id="N13888">Now, for completeness, we should add a <code class="cf ic">has_many</code> directive to our <code class="cf ic">Product</code> model. After all, if we have lots of carts, each product might have many line items referencing it. This time, we will make use of validation code to prevent removal of products that are referenced by line items.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_f/app/models/product.rb">rails31/depot_f/app/models/product.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">class</strong> Product &lt; ActiveRecord::Base</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">has_many :line_items</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">before_destroy :ensure_not_referenced_by_any_line_item</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment">#...</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">private</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># ensure that there are no line items referencing this product</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">def</strong> ensure_not_referenced_by_any_line_item</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">if</strong> line_items.empty?</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">return</strong> true</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">else</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">errors.add(:base, <em class="string">'Line Items present'</em>)</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">return</strong> false</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N138F4">Here we declare that a product has many line items and define a <span class="emph">hook</span> method named <code class="cf methodname">ensure_not_referenced_by_any_line_item</code>. A hook method is a method that Rails calls automatically at a given point in an object’s life. In this case, the method will be called before Rails attempts to destroy a row in the database. If the hook method returns false, the row will not be destroyed.</p>

  <p id="N13901">Note that we have direct access to the <code class="cf ic">errors</code> object. This is the same place that the <code class="cf methodname">validates</code> stores error messages. Errors can be associated with individual attributes, but in this case we associate the error with the base object itself.</p>

  <p id="N13913">We’ll have more to say about intermodel relationships starting <a href="../Text/f_0104.html#sec.ar.relationships">​here​</a>.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
