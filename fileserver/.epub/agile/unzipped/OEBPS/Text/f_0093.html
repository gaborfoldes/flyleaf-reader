<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="sec.capistrano">16.2 Iteration K2: Deploying Remotely with Capistrano</h2>

  <p id="N182D2">If you are a large shop, having a pool of dedicated servers that you administer so that you can ensure that they are running the same version of the necessary software is the way to go. For more modest needs, a shared server will do, but we will have to take additional care to deal with the fact that the versions of software installed may not always match the version that we have installed on our development machine.</p>

  <p id="N182DA">Don’t worry, we’ll talk you through it.</p>

  <h3 id="sec.server.prep">Prepping Your Deployment Server</h3>

  <p id="N182E2">Although putting our software under version control is a really, really, really good idea during development, not putting our software under version control when it comes to deployment is downright foolhardy&mdash;enough so that the software that we have selected to manage your deployment, namely, Capistrano, all but requires it.</p>

  <p id="N182EC">Plenty of software configuration management (SCM) systems are available. Subversion, for example, is a particularly good one. But if you haven’t yet chosen one, go with Git, which is easy to set up and doesn’t require a separate server process. The examples that follow will be based on Git, but if you picked a different SCM system, don’t worry. Capistrano doesn’t much care which one you pick, just so long as you pick one.</p>

  <p id="N182FB">The first step is to create an empty repository on a machine accessible by your deployment servers. In fact, if we have only one deployment server, there is no reason that it can’t do double duty as your Git server. So, log onto that server, and issue the following commands:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">mkdir -p ~/git/depot.git</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">cd ~/git/depot.git</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git --bare init</strong></code></td>
    </tr>
  </table>

  <p id="N18318">The next thing to be aware of is that even if the SCM server and our web server are the same physical machine, Capistrano will be accessing our SCM software as if it were remote. We can make this smoother by generating a public key (if you don’t already have one) and then using it to give ourselves permission to access our own server:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">test -e ~/.ssh/id_dsa.pub || ssh-keygen -t dsa</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">cat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys2</strong></code></td>
    </tr>
  </table>

  <p id="N1832F">Test this by <code class="cf commandname">ssh</code>’ing into your own server. Among other things, this will ensure that your <code class="cf filename">known_hosts</code> file is updated.</p>

  <p id="N18338">While we are here, we have one last thing to attend to. Capistrano will insert a directory named <code class="cf dir">current</code> between our application directory name and the Rails subdirectories, including the <code class="cf dir">public</code> subdirectory. This means you will have to adjust your <code class="cf ic">DocumentRoot</code> in your <code class="cf filename">httpd.conf</code> if you control your own server or in a control panel for your shared host:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">DocumentRoot /home/rubys/work/depot/current/public/</code></td>
    </tr>
  </table>

  <p id="N18352">That’s it for the server! From here on out, we will be doing everything from your development machine.</p>

  <h3 id="sec.bundle.pack">Getting an Application Under Control</h3>

  <p id="N1835A">The first thing we are going to do is update our <code class="cf filename">Gemfile</code> to indicate that we are using Capistrano.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_t/Gemfile">rails31/depot_t/Gemfile</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">source 'http://rubygems.org'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'rails', '3.1.0'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Bundle edge Rails instead:</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># gem 'rails', :git =&gt; 'git://github.com/rails/rails.git'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'sqlite3'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">group :production do</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'mysql2'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">end</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Gems used only for assets and not required</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># in production environments by default.</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">group :assets do</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'sass-rails', " ~&gt; 3.1.0.rc"</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'coffee-rails', "~&gt; 3.1.0.rc"</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'uglifier'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">end</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'jquery-rails'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Use unicorn as the web server</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># gem 'unicorn'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Deploy with Capistrano</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'capistrano'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># To use debugger</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># gem 'ruby-debug19', :require =&gt; 'ruby-debug'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">group :test do</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Pretty printed test output</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'turn', :require =&gt; false</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">end</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'will_paginate', '~&gt; 3.0'</code></td>
    </tr>
  </table>

  <p id="N183CD">We can now install Capistrano using <code class="cf ic">bundle install</code>.</p>

  <p id="N183D9">If you haven’t already put your application under configuration control, do so now:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">cd your_application_directory</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git init</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git add .</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git commit -m "initial commit"</strong></code></td>
    </tr>
  </table>

  <p id="N183FC">This next step is optional but might be a good idea if either you don’t have full control of the deployment server or you have many deployment servers to manage. We are going to use a second feature of Bundler, namely, the <code class="cf ic">pack</code> command. What it does is put the version of the software that you are dependent on into the repository:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">bundle pack</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git add Gemfile.lock vendor/cache</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git commit -m "bundle gems"</strong></code></td>
    </tr>
  </table>

  <p id="N18425">We will explain more of the features of Bundler in Section 25.3, <a href="../Text/f_0138.html#sec.bundler">​<em>Managing Dependencies with Bundler</em>​</a>.</p>

  <p id="N1842B">From here, it is a simple matter to push all your code out to the server:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git remote add origin ssh://user@host/~/git/depot.git</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git push origin master</strong></code></td>
    </tr>
  </table>

  <p id="N18442">With these few steps, you have gained control over what is being deployed. You control <span class="emph">what</span> is being committed to your local repository. You control <span class="emph">when</span> this is being pushed out to your server. Next up, you will control putting this code into production.</p>

  <h3 id="heading_id_2">Deploying the Application Remotely</h3>

  <p id="N1845D">We previously deployed the application locally on a server. Now we are going to do a second deployment, this time remotely.</p>

  <p id="N18460">The prep work is now done. Our code is now on the SCM server where it can be accessed by the app server. Again, it matters not whether these two servers are the same; what is important here is the <span class="emph">roles</span> that are being performed.</p>

  <p id="N18466">To add the necessary files to the project for Capistrano to do its magic, execute the following command:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">capify .</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">[add] writing './Capfile'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">[add] writing './config/deploy.rb'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">[done] capified!</code></td>
    </tr>
  </table>

  <p id="N18480">From the output, we can see that Capistrano set up two files. The first, <code class="cf filename">Capfile</code>, is Capistrano’s analog to a <code class="cf filename">Rakefile</code>. We won’t need to touch this file further. The second, <code class="cf filename">config/deploy.rb</code>, contains the recipes needed to deploy our application. Capistrano will provide us with a minimal version of this file, but the following is a somewhat more complete version that you can download and use as a starting point:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_t/Capfile">rails31/depot_t/Capfile</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">load 'deploy' if respond_to?(:namespace) # cap2 differentiator</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Uncomment if you are using Rails' asset pipeline</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">load 'deploy/assets'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">Dir['vendor/gems/*/recipes/*.rb','vendor/plugins/*/recipes/*.rb'].</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">each { |plugin| load(plugin) }</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">load 'config/deploy' # remove this line to skip loading any of the default tasks</code></td>
    </tr>
  </table>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_t/config/deploy.rb">rails31/depot_t/config/deploy.rb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># be sure to change these</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :user, <em class="string">'rubys'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :domain, <em class="string">'depot.pragprog.com'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :application, <em class="string">'depot'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># adjust if you are using RVM, remove if you are not</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$:.unshift(File.expand_path(<em class="string">'./lib'</em>, ENV[<em class="string">'rvm_path'</em>]))</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">require <em class="string">"rvm/capistrano"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :rvm_ruby_string, <em class="string">'1.9.2'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :rvm_type, :user</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># file paths</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :repository, <em class="string">"</em>#{user}<em class="string">@</em>#{domain}<em class="string">:git/</em>#{application}<em class="string">.git"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :deploy_to, <em class="string">"/home/</em>#{user}<em class="string">/</em>#{domain}<em class="string">"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># distribute your applications across servers (the instructions below put them</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># all on the same server, defined above as 'domain', adjust as necessary)</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">role :app, domain</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">role :web, domain</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">role :db, domain, :primary =&gt; true</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># you might need to set this if you aren't seeing password prompts</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># default_run_options[:pty] = true</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># As Capistrano executes in a non-interactive mode and therefore doesn't cause</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># any of your shell profile scripts to be run, the following might be needed</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># if (for example) you have locally installed gems or applications. Note:</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># this needs to contain the full values for the variables set, not simply</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># the deltas.</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># default_environment['PATH']='&lt;your paths&gt;:/usr/local/bin:/usr/bin:/bin'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># default_environment['GEM_PATH']='&lt;your paths&gt;:/usr/lib/ruby/gems/1.8'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><em class="comment"># miscellaneous options</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :deploy_via, :remote_cache</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :scm, <em class="string">'git'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :branch, <em class="string">'master'</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :scm_verbose, true</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :use_sudo, false</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">set :rails_env, :production</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">namespace :deploy <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">desc <em class="string">"cause Passenger to initiate a restart"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">task :restart <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">run <em class="string">"touch</em> #{current_path}<em class="string">/tmp/restart.txt"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">desc <em class="string">"reload the database with seed data"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">task :seed <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">run <em class="string">"cd</em> #{current_path}<em class="string">; rake db:seed RAILS_ENV=</em>#{rails_env}<em class="string">"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">after <em class="string">"deploy:update_code"</em>, :bundle_install</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">desc <em class="string">"install the necessary prerequisites"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">task :bundle_install, :roles =&gt; :app <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">run <em class="string">"cd</em> #{release_path} <em class="string">&amp;&amp; bundle install"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N185B6">We will need to edit several properties to match our application. We certainly will need to change the <code class="cf ic">:user</code>, <code class="cf ic">:domain</code>, and <code class="cf ic">:application</code>. The <code class="cf ic">:repository</code> matches where we put our Git file earlier. The <code class="cf ic">:deploy_to</code> may need to be tweaked to match where we told Apache it could find the <code class="cf filename">config/public</code> directory for the application.</p>

  <p id="N185CB">We’ve also included a few lines to show how to instruct Capistrano to make use of RVM.<a href="../Text/f_0094.html#FOOTNOTE-34" id="FNPTR-34">[34]</a> If RVM was installed as root on your deployment machine, remove the <code class="cf ic">set :rvm_type</code> line. Adjust the <code class="cf ic">:rvm_ruby_string</code> to match the version of the Ruby interpreter that you have installed and wish to use. If you are not using RVM at all, remove these lines.</p>

  <p id="N185DA">The <code class="cf ic">default_run_options</code> and <code class="cf ic">default_environment</code> are to be used only if you have specific problems. The “miscellaneous options” provided are based on Git.</p>

  <p id="N185E3">Two tasks are defined. One tells Capistrano how to restart Passenger. The other installs the gems from the copy that we previously placed on the Git repository. Feel free to adjust these tasks as you see fit.</p>

  <p id="N185E6">The first time we deploy our application, we have to perform an additional step to set up the basic directory structure to deploy into on the server:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">cap deploy:setup</strong></code></td>
    </tr>
  </table>

  <p id="N185F7">When we execute this command, Capistrano will prompt us for our server’s password. If it fails to do so and fails to log in, we might need to uncomment out the <code class="cf ic">default_run_options</code> line in our <code class="cf filename">deploy.rb</code> file and try again. Once it can connect successfully, it will make the necessary directories. After this command is done, we can check out the configuration for any other problems:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">cap deploy:check</strong></code></td>
    </tr>
  </table>

  <p id="N1860E">As before, we might need to uncomment out and adjust the <code class="cf ic">default_environment</code> lines in our <code class="cf filename">deploy.rb</code>. We can repeat this command until it completes successfully, addressing any issues it may identify.</p>

  <p id="N18617">Now we’re ready to do the deployment. Since we have done all of the necessary prep work and checked the results, it should go smoothly:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">cap deploy:migrations</strong></code></td>
    </tr>
  </table>

  <p id="N18628">At this point, we should be off to the races.</p>

  <h3 id="heading_id_3">Rinse, Wash, Repeat</h3>

  <p id="N1862F">Once we’ve gotten this far, our server is ready to have new versions of our application deployed to it any time we want. All we need to do is check our changes into the repository and then redeploy. At this point, we have two Capistrano files that haven’t been checked in. Although they aren’t needed by the app server, we can still use them to test the deployment process:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git add .</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git commit -m "add cap files"</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">git push</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">cap deploy</strong></code></td>
    </tr>
  </table>

  <p id="N18652">The first three commands will update the SCM server. Once you become more familiar with Git, you may want to have finer control over when and which files are added, you may want to incrementally commit multiple changes before deployment, and so on. It is only the final command that will update our app, web, and database servers.</p>

  <p id="N18655">If for some reason we need to step back in time and go back to a previous version of our application, we can use this:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">cap deploy:rollback</strong></code></td>
    </tr>
  </table>

  <p id="N18666">We now have a fully deployed application and can deploy as needed to update the code running on the server. Each time we deploy our application, a new version of it is checked out onto the server, some symlinks are updated, and the Passenger processes are restarted.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
