<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="sec.pagination">12.3 Iteration G3: Pagination</h2>

  <p id="N15CD1">At the moment, we have a few products, a few carts at any one time, and a few line items per cart or order, but we can have essentially an unlimited number of orders, and we hope to have many&mdash;enough so that displaying all of them on an orders page will quickly become unwieldy. Enter the <code class="cf ic">will_paginate</code> plugin. This plugin extends Rails to provide this much-needed function.</p>

  <p id="N15CE9">Why a plugin? Back in Rails 1.0, this functionality was part of Rails itself. But there were competing ideas on how this could be implemented and improved, and the function was broken out in order to enable innovation to thrive.</p>

  <p id="N15CEC">The first thing we need to do is to inform Rails of our intent to use the plugin. We do that by modifying the <code class="cf filename">Gemfile</code> file. We need to specify that we want a version that is greater than or equal to <code class="cf ic">3.0</code> because previous versions don’t work with Rails 3.1.</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_q/Gemfile">rails31/depot_q/Gemfile</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">source 'http://rubygems.org'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'rails', '3.1.0'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Bundle edge Rails instead:</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># gem 'rails', :git =&gt; 'git://github.com/rails/rails.git'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'sqlite3'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Gems used only for assets and not required</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># in production environments by default.</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">group :assets do</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'sass-rails', " ~&gt; 3.1.0.rc"</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'coffee-rails', "~&gt; 3.1.0.rc"</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'uglifier'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">end</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'jquery-rails'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Use unicorn as the web server</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># gem 'unicorn'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Deploy with Capistrano</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># gem 'capistrano'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># To use debugger</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># gem 'ruby-debug19', :require =&gt; 'ruby-debug'</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">group :test do</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"># Pretty printed test output</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'turn', :require =&gt; false</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">end</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1">gem 'will_paginate', '~&gt; 3.0'</code></td>
    </tr>
  </table>

  <p id="p.bundle.install">With this in place, we can use the <code class="cf commandname">bundle</code> command to install our dependencies:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">depot&gt; <strong class="prompt">bundle install</strong></code></td>
    </tr>
  </table>

  <p id="N15D89">Depending on your operating system and your setup, you may need to run this command as root.</p>

  <p id="N15D8C">The <code class="cf ic">bundle</code> command will actually do much more. It will cross-check gem dependencies, find a configuration that works, and download and install whatever components are necessary. But this needn’t concern us now; we added only one component, and we can rest assured that this one is included in the gems that the bundler installed.</p>

  <p id="N15D96">We must do one last thing after updating or installing a new gem: restart the server. Although Rails does a good job of detecting and keeping up with your latest changes to your application, it is impossible to predict what needs to be done when an entire gem is added or replaced.</p>

  <p id="N15DAC">Now let’s generate some test data. We could click repeatedly on the buttons we have, but computers are good at this. This isn’t exactly seed data, simply something done once and thrown away. Let’s create a file in the <code class="cf dir">script</code> directory.</p>

  <p id="N15DB3">This will create 100 orders with no line items in them. Feel free to modify the script to create line items if you are so inclined. Note that this code does all this work in one transaction. This isn’t precisely required for this activity but does speed up the processing.</p>

  <p id="N15DB6">Note that we don’t have any <code class="cf ic">require</code> statements or initialization to open or close the database. We will allow Rails to take care of this for us:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">rails runner script/load_orders.rb</code></td>
    </tr>
  </table>

  <p id="N15DD2">Now that the setup is done, we are ready to make the changes necessary to our application. First, we will modify our controller to call <code class="cf methodname">paginate</code>, passing it in the page and the order in which we want the results displayed:</p>

  <p id="N15DD8">Next, we will add links to the bottom of our index view:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_q/app/views/orders/index.html.erb">rails31/depot_q/app/views/orders/index.html.erb</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;h1&gt;</strong>Listing orders<strong class="prompt">&lt;/h1&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;table&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;tr&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;th&gt;</strong>Name<strong class="prompt">&lt;/th&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;th&gt;</strong>Address<strong class="prompt">&lt;/th&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;th&gt;</strong>Email<strong class="prompt">&lt;/th&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;th&gt;</strong>Pay type<strong class="prompt">&lt;/th&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;th&gt;</strong> <strong class="prompt">&lt;/th&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;th&gt;</strong> <strong class="prompt">&lt;/th&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;th&gt;</strong> <strong class="prompt">&lt;/th&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/tr&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% @orders.each <strong class="prompt">do</strong> |order| %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;tr&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td&gt;</strong>&lt;%= order.name %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td&gt;</strong>&lt;%= order.address %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td&gt;</strong>&lt;%= order.email %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td&gt;</strong>&lt;%= order.pay_type %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td&gt;</strong>&lt;%= link_to <em class="string">'Show'</em>, order %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td&gt;</strong>&lt;%= link_to <em class="string">'Edit'</em>, edit_order_path(order) %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;td&gt;</strong>&lt;%= link_to <em class="string">'Destroy'</em>, order, confirm: <em class="string">'Are you sure?'</em>,</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">method: :delete %&gt;<strong class="prompt">&lt;/td&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/tr&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;% <strong class="prompt">end</strong> %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;/table&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;br</strong> <strong class="prompt">/&gt;</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">&lt;%= link_to <em class="string">'New Order'</em>, new_order_path %&gt;</code></td>
    </tr>

    <tr>
      <td class="codeprefix"><span class="codehighlightline">*</span> &nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">&lt;p&gt;</strong>&lt;%= will_paginate @orders %&gt;<strong class="prompt">&lt;/p&gt;</strong></code></td>
    </tr>
  </table>

  <p id="N15EAB">And that is all there is to it! The default is to show thirty entries per page, and the links will show up only if there are more than one page of orders. The controller specifies the number of orders to display on a page using the <code class="cf ic">:per_page</code> option. See Figure 26, <a href="#fig.depot.paginate">​<em>Showing ten orders out of more than a hundred</em>​</a>.</p>

  <table class="figure" id="fig.depot.paginate">
    <tr>
      <td><img alt="images/depot_paginate.png" src="../Images/depot_paginate.png" xmlns:str="http://exslt.org/strings" /></td>
    </tr>

    <tr>
      <td align="center">
        <hr />
        <b>Figure 26. Showing ten orders out of more than a hundred</b>
      </td>
    </tr>
  </table>

  <p id="N15EBD">The customer likes it. We’ve implemented product maintenance, a basic catalog, and a shopping cart, and now we have a simple ordering system. Obviously we’ll also have to write some kind of fulfillment application, but that can wait for a new iteration. (And that iteration is one that we’ll skip in this book; it doesn’t have much new to say about Rails.)</p>

  <h3 id="heading_id_2">What We Just Did</h3>

  <p id="N15ECF">In a fairly short amount of time, we did the following:</p>

  <ul>
    <li>
      <p id="N15ED5">We created a form to capture details for the order and linked it to a new order model.</p>
    </li>

    <li>
      <p id="N15ED9">We added validation and used helper methods to display errors to the user.</p>
    </li>

    <li>
      <p id="N15EDD">We installed and used a plugin to paginate the list of orders.</p>
    </li>

    <li>
      <p id="N15EE1">We provided a feed so that the administrator can monitor orders as they come in.</p>
    </li>
  </ul>

  <h3 id="heading_id_3">Playtime</h3>

  <p id="N15EE8">Here’s some stuff to try on your own:</p>

  <ul>
    <li>
      <p id="N15EEE">Get HTML-, XML-, and JSON-formatted views working for <code class="cf ic">who_bought</code> requests. Experiment with including the order information in the XML view by rendering <code class="cf ic">@product.to_xml(include: :orders)</code>. Do the same thing for JSON.</p>
    </li>

    <li>
      <p id="N15EF8">What happens if you click the <code class="cf keystroke">Checkout</code> button in the sidebar while the checkout screen is already displayed? Can you find a way to disable the button in this circumstance?</p>
    </li>

    <li>
      <p id="N15EFF">The list of possible payment types is currently stored as a constant in the <code class="cf class">Order</code> class. Can you move this list into a database table? Can you still make validation work for the field?</p>
    </li>
  </ul>

  <p id="N15F05">(You’ll find hints at <a href="http://www.pragprog.com/wikis/wiki/RailsPlayTime">http://www.pragprog.com/wikis/wiki/RailsPlayTime</a>.)</p>

  <div class="copyright">
    Copyright © 2011, The Pragmatic Bookshelf.
  </div><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
