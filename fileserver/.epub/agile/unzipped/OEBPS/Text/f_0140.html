<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Agile Web Development with Rails</title>
  <link href="../Styles/bookshelf.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/book_local.css" rel="stylesheet" type="text/css" />
  <link href="../Styles/page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml" />
  <meta content="rails4" name="bookcode" />
  <style type="text/css">
/*<![CDATA[*/

  code.sgc-1 {white-space: pre-wrap;}
  /*]]>*/
  </style>
</head>

<body>
  <h2 id="sec.rake">25.5 Automating Tasks with Rake</h2>

  <p id="N1F789">Rake is a program that often is taken for granted. It is used to automate tasks, particularly tasks that may have a number of dependencies. The tasks are defined by the <code class="cf filename">Rakefile</code> that you will find in your application’s root directory.</p>

  <p id="N1F794"><code class="cf ic">db:setup</code> is an example of such a task. To see what subtasks are involved, run Rake with the <code class="cf ic">--trace</code> and <code class="cf ic">--dry-run</code> options:</p>

  <table class="processedcode">
    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">$ <strong class="prompt">rake --trace --dry-run db:setup</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">(in /home/rubys/work/depot)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Invoke db:setup (first_time)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Invoke db:create (first_time)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Invoke db:load_config (first_time)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Invoke rails_env (first_time)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Execute (dry run) rails_env</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Execute (dry run) db:load_config</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Execute (dry run) db:create</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Invoke db:schema:load (first_time)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Invoke environment (first_time)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Execute (dry run) environment</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Execute (dry run) db:schema:load</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Invoke db:seed (first_time)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Invoke db:abort_if_pending_migrations (first_time)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Invoke environment</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Execute (dry run) db:abort_if_pending_migrations</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Execute (dry run) db:seed</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">** Execute (dry run) db:setup</code></td>
    </tr>
  </table>

  <p id="N1F7E9">Executing the right steps in the right order is vital for repeatable deployments; that’s why this particular task was used in <a href="../Text/f_0092.html#sec.test.db">​<em>Loading the Database</em>​</a>.</p>

  <p id="N1F7EF">You can see a list of available tasks using <code class="cf ic">rake --tasks</code>. The tasks that Rails provides are just a starter set; you are welcome to create more tasks. You do so simply by creating new files in the <code class="cf dir">lib/tasks</code> directory containing Ruby code.</p>

  <p id="N1F7F8">Here’s an example that will back up the production database:</p>

  <table class="processedcode">
    <tr class="livecodelozenge">
      <td colspan="2"><a href="http://media.pragprog.com/titles/rails4/code/rails31/depot_u/lib/tasks/db_backup.rake">rails31/depot_u/lib/tasks/db_backup.rake</a></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">namespace :db <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">desc <em class="string">"Backup the production database"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">task :backup =&gt; :environment <strong class="prompt">do</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">backup_dir = ENV[<em class="string">'DIR'</em>] || File.join(Rails.root, <em class="string">'db'</em>, <em class="string">'backup'</em>)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">source = File.join(Rails.root, <em class="string">'db'</em>, <em class="string">"production.db"</em>)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">dest = File.join(backup_dir, <em class="string">"production.backup"</em>)</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">makedirs backup_dir, :verbose =&gt; true</code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1">sh <em class="string">"sqlite3</em> #{source} <em class="string">.dump &gt;</em> #{dest}<em class="string">"</em></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"></td>
    </tr>

    <tr>
      <td class="codeprefix">&nbsp;</td>

      <td class="codeline"><code class="sgc-1"><strong class="prompt">end</strong></code></td>
    </tr>
  </table>

  <p id="N1F853">The first line contains a namespace. We put this backup task in the <code class="cf ic">db</code> namespace.</p>

  <p id="N1F859">The second line contains a description. This description will show up when you list tasks. If you run the <code class="cf ic">rails --tasks</code> command again, you will see that your new task is included along with the ones that Rails provided.</p>

  <p id="N1F85F">The next line contains the task as well as any dependencies it might have. Depending on <code class="cf ic">environment</code> is roughly equivalent to loading everything that <code class="cf ic">rails console</code> provides.</p>

  <p id="N1F868">The block passed to the task is standard Ruby code. In our example, we determine the source and destination directories (where the destination will default to <code class="cf ic">db/backup</code> but can be overridden by a <code class="cf ic">DIR</code> parameter on the command line), then proceed to make the backup directory (if necessary), and finally execute the <code class="cf ic">sqlite3 dump</code> command.</p><script src="../Misc/book_local.js" type="text/javascript">
</script>
</body>
</html>
